{% extends "base.html" %}

{% block title %}Dashboard - Azure IPAM{% endblock %}

{% block content %}
<div id="loading" style="text-align: center; padding: 40px;">
    Loading your Azure network data...
</div>

<div id="dashboard" style="display: none;">
    <!-- IP Search Hero Section -->
    <div class="search-hero">
        <h2>üîç Find Any IP Address</h2>
        <div class="ip-search-container">
            <input type="text" id="ipSearchInput" placeholder="Search IP (e.g., 10.0.1.50) or CIDR (e.g., 192.168.0.0/24)" class="ip-search-input">
            <button class="search-btn" onclick="searchIP()">Search</button>
            <button class="search-btn" onclick="showNetworkBrowser('search')" style="background: rgba(255,255,255,0.3);">Browse</button>
        </div>
        <div id="searchResults" class="search-results"></div>
    </div>

    <!-- IP Scope Overview -->
    <div class="scope-overview">
        <h2>üìä Total IP Address Scope</h2>
        <div class="scope-stats">
            <div class="scope-card total clickable-card" onclick="showTopIPConsumers()">
                <div class="scope-cidr-list" id="activeCIDRs">
                    <div class="cidr-header">Active CIDR Blocks</div>
                    <div class="cidr-loading">Loading...</div>
                </div>
                <div class="scope-label">Top IP Consumers</div>
                <small class="card-action">Click to view detailed usage</small>
                <div class="card-arrow">‚Üí</div>
            </div>
            <div class="scope-card used clickable-card" onclick="showTopIPConsumers()">
                <div class="scope-number" id="totalUsed">-</div>
                <div class="scope-label">In Use</div>
                <small class="card-action">Click to view usage</small>
                <div class="card-arrow">‚Üí</div>
            </div>
            <div class="scope-card reserved clickable-card" onclick="showReservations()">
                <div class="scope-number" id="totalReserved">0</div>
                <div class="scope-label">Reserved</div>
                <small class="card-action">Click to manage</small>
                <div class="card-arrow">‚Üí</div>
            </div>
            <div class="scope-card available clickable-card" onclick="findAvailableSubnets()">
                <div class="scope-number" id="totalAvailable">-</div>
                <div class="scope-label">Available</div>
                <small class="card-action">Click to find space</small>
                <div class="card-arrow">‚Üí</div>
            </div>
        </div>
        <div class="scope-bar">
            <div class="scope-progress">
                <div id="usedBar" class="progress-segment used-segment"></div>
                <div id="reservedBar" class="progress-segment reserved-segment"></div>
                <div id="availableBar" class="progress-segment available-segment"></div>
            </div>
            <div class="scope-legend">
                <span class="legend-item"><span class="legend-color used-color"></span>Used</span>
                <span class="legend-item"><span class="legend-color reserved-color"></span>Reserved</span>
                <span class="legend-item"><span class="legend-color available-color"></span>Available</span>
            </div>
        </div>
        <div class="scope-actions">
            <button class="scope-btn" onclick="showCapacityDetails()">üìã Capacity Details</button>
            <button class="scope-btn" onclick="showReservations()">üîí Manage Reservations</button>
            <button class="scope-btn" onclick="planCapacity()">üìà Plan Expansion</button>
        </div>
    </div>

    <!-- Quick Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card clickable-card" onclick="showAllNetworks()">
            <div class="stat-icon">üåê</div>
            <div class="stat-content">
                <h3 id="totalNetworks">-</h3>
                <p>Virtual Networks</p>
                <small class="card-action">Click to view all</small>
            </div>
            <div class="card-arrow">‚Üí</div>
        </div>
        <div class="stat-card clickable-card" onclick="showAllSubnets()">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <h3 id="totalSubnets">-</h3>
                <p>Subnets</p>
                <small class="card-action">Click to view all</small>
            </div>
            <div class="card-arrow">‚Üí</div>
        </div>
        <div class="stat-card clickable-card" onclick="showCriticalSubnets()">
            <div class="stat-icon">üî¥</div>
            <div class="stat-content">
                <h3 id="criticalSubnets">-</h3>
                <p>Critical Usage (>90%)</p>
                <small class="card-action">Click to investigate</small>
            </div>
            <div class="card-arrow">‚Üí</div>
        </div>
        <div class="stat-card clickable-card" onclick="showTopIPConsumers()">
            <div class="stat-icon">üí°</div>
            <div class="stat-content">
                <h3 id="totalUsedIPs">-</h3>
                <p>IPs In Use</p>
                <small class="card-action">Click to see usage</small>
            </div>
            <div class="card-arrow">‚Üí</div>
        </div>
    </div>

    <!-- Alerts and Warnings -->
    <div class="alerts-section" id="alertsSection" style="display: none;">
        <h3>‚ö†Ô∏è Capacity Alerts</h3>
        <div id="alertsList" class="alerts-list"></div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3>üöÄ Quick Actions</h3>
        <div class="action-buttons">
            <button class="action-btn" onclick="findAvailableSubnets()">
                <span class="action-icon">üéØ</span>
                Find Available Space
            </button>
            <button class="action-btn" onclick="showNetworkBrowser()">
                <span class="action-icon">üóÇÔ∏è</span>
                Browse Networks
            </button>
            <button class="action-btn" onclick="showIPConflicts()">
                <span class="action-icon">‚ö°</span>
                Check IP Conflicts
            </button>
            <button class="action-btn" onclick="exportReport()">
                <span class="action-icon">üìã</span>
                Export Report
            </button>
            <button class="action-btn" onclick="showGrowthTrends()">
                <span class="action-icon">üìà</span>
                Growth Analysis
            </button>
            <button class="action-btn" onclick="showNetworkTopology()">
                <span class="action-icon">üó∫Ô∏è</span>
                Network Topology
            </button>
        </div>
    </div>

    <!-- Network Overview -->
    <div class="networks-section">
        <div class="section-header">
            <h3>üåê Your Azure Subscriptions</h3>
            <div class="filter-controls">
                <input type="text" id="networkFilter" placeholder="Filter by name, location, or resource group..." class="filter-input">
                <select id="utilizationFilter" class="filter-select">
                    <option value="">All Utilization Levels</option>
                    <option value="healthy">Healthy (0-50%)</option>
                    <option value="moderate">Moderate (50-75%)</option>
                    <option value="warning">Warning (75-90%)</option>
                    <option value="critical">Critical (90%+)</option>
                </select>
            </div>
        </div>
        
        <div id="subscriptions" class="subscriptions-grid">
            <!-- Subscriptions will be loaded here -->
        </div>
    </div>
</div>

<!-- Universal Network Browser Modal -->
<div id="universalBrowserModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 90%; max-height: 90%;">
        <div class="modal-header">
            <h3 id="browserModalTitle">üóÇÔ∏è Browse Networks</h3>
            <div style="display: flex; gap: 12px; align-items: center;">
                <input type="text" id="browserSearchInput" placeholder="Search networks, subnets..." 
                       style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px;"
                       oninput="filterBrowserResults()">
                <select id="browserFilterType" onchange="filterBrowserResults()" style="padding: 6px;">
                    <option value="">All Types</option>
                    <option value="subscription">Subscriptions</option>
                    <option value="vnet">Virtual Networks</option>
                    <option value="subnet">Subnets</option>
                </select>
                <select id="browserFilterUtilization" onchange="filterBrowserResults()" style="padding: 6px;">
                    <option value="">All Utilization</option>
                    <option value="healthy">Healthy (0-50%)</option>
                    <option value="warning">Warning (50-75%)</option>
                    <option value="high">High (75-90%)</option>
                    <option value="critical">Critical (90%+)</option>
                </select>
                <span class="close" onclick="closeUniversalBrowser()">&times;</span>
            </div>
        </div>
        <div class="modal-body" style="display: flex; gap: 16px; height: 70vh;">
            <!-- Left Panel - Tree Browser -->
            <div style="flex: 2; border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; background: #f8f9fa; overflow-y: auto;">
                <div id="universalBrowserTree">
                    <!-- Tree will be loaded here -->
                </div>
            </div>
            
            <!-- Right Panel - Details -->
            <div style="flex: 1; border: 1px solid #dee2e6; border-radius: 8px; background: white;">
                <div id="browserDetailsPanel" style="padding: 16px; height: 100%; overflow-y: auto;">
                    <div style="text-align: center; color: #666; margin-top: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üóÇÔ∏è</div>
                        <h4>Select a network component</h4>
                        <p>Click on any subscription, network, or subnet to view details and available actions.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Range Browser Modal (for reservations) -->
<div id="rangeBrowserModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üåê Browse Available IP Ranges</h3>
            <span class="close" onclick="closeRangeBrowser()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="browser-container">
                <div class="browser-tree" id="networkTree">
                    <!-- Network tree will be loaded here -->
                </div>
                <div class="selected-range" id="selectedRange" style="display: none;">
                    <h4>Selected Range</h4>
                    <div class="range-details" id="rangeDetails"></div>
                    <button class="btn" onclick="useSelectedRange()">Use This Range</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- IP Reservations Modal -->
<div id="reservationsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîí IP Address Reservations</h3>
            <span class="close" onclick="closeReservationsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="reservation-form">
                <h4>Create New Reservation</h4>
                
                <!-- Reservation Type Selection -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600;">Reservation Type:</label>
                    <div style="display: flex; gap: 16px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; cursor: pointer;">
                            <input type="radio" name="reservationType" value="single" checked onchange="updateReservationForm()">
                            Single IP Address
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; cursor: pointer;">
                            <input type="radio" name="reservationType" value="subnet" onchange="updateReservationForm()">
                            Subnet Block
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; font-weight: normal; cursor: pointer;">
                            <input type="radio" name="reservationType" value="custom" onchange="updateReservationForm()">
                            Custom CIDR
                        </label>
                    </div>
                </div>

                <!-- IP Range Input with Dynamic Labels and Help -->
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label id="rangeLabel">IP Address:</label>
                        <input type="text" id="reservationRange" placeholder="e.g., 10.0.1.100" class="form-input" oninput="updateIPCount()">
                        <small id="rangeHelp" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                            Enter a single IP address like 10.0.1.100
                        </small>
                        
                        <!-- Subnet Size Selector (hidden by default) -->
                        <div id="subnetSizeSelector" style="display: none; margin-top: 8px;">
                            <label>Subnet Size:</label>
                            <select id="subnetSize" class="form-input" style="width: auto; display: inline-block; margin-left: 8px;" onchange="updateIPCount()">
                                <option value="24">/24 (256 IPs)</option>
                                <option value="25">/25 (128 IPs)</option>
                                <option value="26">/26 (64 IPs)</option>
                                <option value="27">/27 (32 IPs)</option>
                                <option value="28">/28 (16 IPs)</option>
                                <option value="29">/29 (8 IPs)</option>
                                <option value="30">/30 (4 IPs)</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button type="button" class="browse-btn" onclick="showRangeBrowser()">Browse Ranges</button>
                    </div>
                </div>

                <!-- IP Count Display -->
                <div id="ipCountDisplay" style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                    <strong>Reserving:</strong> <span id="ipCountText">1 IP address</span>
                </div>

                <!-- Rest of the form -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label>Project/Purpose:</label>
                        <input type="text" id="reservationPurpose" placeholder="e.g., Database Server" class="form-input">
                    </div>
                    <div>
                        <label>Owner/Team:</label>
                        <input type="text" id="reservationOwner" placeholder="e.g., Platform Team" class="form-input">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label>Expiration Date:</label>
                        <input type="date" id="reservationExpiry" class="form-input">
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="createReservation()" class="btn">Create Reservation</button>
                    <button onclick="clearReservationForm()" class="btn btn-secondary">Clear Form</button>
                </div>
            </div>
            
            <div class="reservations-list">
                <h4>Current Reservations</h4>
                <div id="reservationsList">
                    <!-- Reservations will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Available Space Modal -->
<div id="availableSpaceModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üéØ Available IP Space</h3>
            <span class="close" onclick="closeAvailableSpaceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="space-search">
                <div style="display: flex; gap: 12px; align-items: end; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label>Looking for:</label>
                        <input type="number" id="requiredIPs" placeholder="Number of IPs needed" min="1" max="1000">
                    </div>
                    <button onclick="findSpaceForIPs()" class="btn">Find Space</button>
                    <button onclick="showNetworkBrowser('available')" class="btn" style="background: #28a745;">Browse Networks</button>
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 16px;">
                    Enter the number of IP addresses you need, or browse networks to explore available capacity.
                </div>
            </div>
            <div id="availableSpaceResults"></div>
        </div>
    </div>
</div>

<!-- Network Details Modal (existing) -->
<div id="networkModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Network Details</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Network content will be loaded here -->
        </div>
    </div>
</div>

<!-- Network Topology Modal -->
<div id="topologyModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 95%; max-height: 95%;">
        <div class="modal-header">
            <h3>üó∫Ô∏è Network Topology Visualization</h3>
            <div style="display: flex; gap: 12px; align-items: center;">
                <select id="topologyView" onchange="switchTopologyView()" style="padding: 6px;">
                    <option value="subscription">By Subscription</option>
                    <option value="utilization">By Utilization</option>
                    <option value="location">By Location</option>
                </select>
                <button onclick="resetTopologyView()" class="btn" style="padding: 6px 12px; font-size: 12px;">Reset View</button>
                <span class="close" onclick="closeTopologyModal()">&times;</span>
            </div>
        </div>
        <div class="modal-body" style="padding: 0; height: 70vh; overflow: hidden;">
            <!-- Legend -->
            <div id="topologyLegend" style="position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-weight: bold; margin-bottom: 8px;">Legend</div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px;">
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 4px;"></span>Healthy (0-50%)</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #ffc107; border-radius: 50%; margin-right: 4px;"></span>Warning (50-75%)</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fd7e14; border-radius: 50%; margin-right: 4px;"></span>High (75-90%)</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 4px;"></span>Critical (90%+)</div>
                </div>
            </div>
            
            <!-- Topology Canvas -->
            <div id="topologyCanvas" style="width: 100%; height: 100%; position: relative;">
                <!-- D3.js visualization will be inserted here -->
            </div>
            
            <!-- Details Panel -->
            <div id="topologyDetails" style="display: none; position: absolute; top: 10px; right: 10px; width: 300px; background: white; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); padding: 16px; z-index: 10;">
                <h4 id="detailsTitle" style="margin: 0 0 12px 0;"></h4>
                <div id="detailsContent"></div>
                <button onclick="hideTopologyDetails()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* IP Scope Overview */
.scope-overview {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 30px;
    border: 1px solid #dee2e6;
}

.scope-overview h2 {
    margin: 0 0 24px 0;
    color: #323130;
    text-align: center;
}

.scope-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.scope-card {
    text-align: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.scope-number {
    font-size: 2.5em;
    font-weight: 700;
    margin-bottom: 8px;
}

.scope-label {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.scope-card.total .scope-number { color: #495057; }
.scope-card.used .scope-number { color: #dc3545; }
.scope-card.reserved .scope-number { color: #ffc107; }
.scope-card.available .scope-number { color: #28a745; }

.scope-cidr-list {
    min-height: 100px;
    display: flex;
    flex-direction: column;
}

.cidr-header {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    text-align: center;
}

.cidr-loading {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    margin-top: 20px;
}

.cidr-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 12px;
    border-bottom: 1px solid #f1f3f4;
}

.cidr-item:last-child {
    border-bottom: none;
}

.cidr-range {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #495057;
}

.cidr-usage {
    color: #dc3545;
    font-weight: 600;
}

.scope-bar {
    margin-bottom: 24px;
}

.scope-progress {
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    margin-bottom: 12px;
}

.progress-segment {
    height: 100%;
    transition: width 0.8s ease-in-out;
}

.used-segment { background: #dc3545; }
.reserved-segment { background: #ffc107; }
.available-segment { background: #28a745; }

.scope-legend {
    display: flex;
    justify-content: center;
    gap: 24px;
    font-size: 14px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.used-color { background: #dc3545; }
.reserved-color { background: #ffc107; }
.available-color { background: #28a745; }

.scope-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
}

.scope-btn {
    padding: 12px 24px;
    background: white;
    border: 2px solid #0078d4;
    color: #0078d4;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.scope-btn:hover {
    background: #0078d4;
    color: white;
    transform: translateY(-1px);
}

/* Reservation Form */
.reservation-form {
    background: #f8f9fa;
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 24px;
}

.reservation-form h4 {
    margin: 0 0 16px 0;
    color: #323130;
}

.form-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    margin-top: 4px;
}

.form-input:focus {
    outline: none;
    border-color: #0078d4;
    box-shadow: 0 0 0 2px rgba(0,120,212,0.2);
}

.reservations-list h4 {
    margin: 0 0 16px 0;
    color: #323130;
}

.reservation-item {
    background: white;
    border: 1px solid #dee2e6;
    border-left: 4px solid #ffc107;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
}

.browse-btn {
    padding: 10px 16px;
    background: #f8f9fa;
    border: 2px solid #0078d4;
    color: #0078d4;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
}

.browse-btn:hover {
    background: #0078d4;
    color: white;
}

.browser-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    min-height: 400px;
}

.browser-tree {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    background: #f8f9fa;
    overflow-y: auto;
    max-height: 500px;
}

.tree-node {
    margin: 8px 0;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
    user-select: none;
}

.tree-node:hover {
    background: #e9ecef;
}

.tree-node.expandable::before {
    content: "‚ñ∂ ";
    color: #6c757d;
    margin-right: 4px;
}

.tree-node.expanded::before {
    content: "‚ñº ";
}

.tree-node.subnet {
    margin-left: 40px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
}

.tree-node.range {
    margin-left: 60px;
    color: #28a745;
    font-weight: bold;
    border: 1px solid #28a745;
    background: rgba(40, 167, 69, 0.1);
}

.tree-node.range:hover {
    background: rgba(40, 167, 69, 0.2);
}

.vnet-node {
    background: white !important;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px !important;
    margin-bottom: 8px !important;
}

.vnet-node:hover {
    background: #f8f9fa !important;
}

.reserve-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.reserve-btn:hover {
    background: #218838;
    transform: translateY(-1px);
}

.selected-range {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    background: white;
}

.range-details {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.reservation-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 8px;
}

.reservation-range {
    font-weight: bold;
    font-size: 16px;
    color: #323130;
}

.reservation-actions {
    display: flex;
    gap: 8px;
}

.btn-small {
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
}

.btn-small.danger {
    border-color: #dc3545;
    color: #dc3545;
}

.btn-small.danger:hover {
    background: #dc3545;
    color: white;
}

/* Search Hero Section */
.search-hero {
    background: linear-gradient(135deg, #0078d4, #106ebe);
    color: white;
    padding: 40px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.search-hero h2 {
    margin: 0 0 24px 0;
    font-size: 2.2em;
    font-weight: 400;
}

.ip-search-container {
    display: flex;
    max-width: 600px;
    margin: 0 auto;
    gap: 12px;
}

.ip-search-input {
    flex: 1;
    padding: 16px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    background: rgba(255,255,255,0.95);
    color: #333;
}

.ip-search-input:focus {
    outline: none;
    background: white;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}

.search-btn {
    padding: 16px 32px;
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.search-btn:hover {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
}

.search-results {
    margin-top: 20px;
    text-align: left;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 20px;
    display: none;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #0078d4;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.clickable-card {
    cursor: pointer;
    user-select: none;
}

.clickable-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,120,212,0.2);
    border-left-color: #106ebe;
}

.clickable-card:active {
    transform: translateY(-1px);
}

.stat-icon {
    font-size: 2.5em;
    opacity: 0.8;
}

.stat-content {
    flex: 1;
}

.stat-content h3 {
    font-size: 2.2em;
    margin: 0;
    color: #0078d4;
    font-weight: 700;
}

.stat-content p {
    margin: 4px 0 0 0;
    color: #666;
    font-weight: 500;
}

.card-action {
    display: block;
    color: #0078d4;
    font-weight: 500;
    margin-top: 4px;
    opacity: 0;
    transition: opacity 0.2s;
}

.clickable-card:hover .card-action {
    opacity: 1;
}

.card-arrow {
    color: #0078d4;
    font-size: 1.5em;
    opacity: 0;
    transition: all 0.2s;
    transform: translateX(-10px);
}

.clickable-card:hover .card-arrow {
    opacity: 1;
    transform: translateX(0);
}

/* Alerts Section */
.alerts-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
}

.alerts-section h3 {
    margin: 0 0 16px 0;
    color: #856404;
}

.alerts-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.alert-item {
    background: white;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #dc3545;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Quick Actions */
.quick-actions {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.quick-actions h3 {
    margin: 0 0 20px 0;
    color: #323130;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    font-weight: 600;
    color: #495057;
}

.action-btn:hover {
    background: linear-gradient(135deg, #e9ecef, #dee2e6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.action-icon {
    font-size: 1.4em;
}

/* Network Section */
.networks-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.section-header h3 {
    margin: 0;
    color: #323130;
}

.filter-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.filter-input, .filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.filter-input {
    min-width: 250px;
}

.subscriptions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

/* Enhanced Network Cards */
.network-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 20px;
    transition: all 0.2s;
    position: relative;
}

.network-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.network-card h4 {
    margin: 0 0 12px 0;
    color: #323130;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.network-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-enabled {
    background: #d4edda;
    color: #155724;
}

.network-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
    font-size: 14px;
}

.stat-item {
    text-align: center;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-number {
    font-weight: 700;
    font-size: 1.2em;
    color: #0078d4;
}

/* Range Browser Modal - Higher Z-Index */
#rangeBrowserModal {
    position: fixed;
    z-index: 1100 !important;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    animation: fadeIn 0.3s;
}

#rangeBrowserModal .modal-content {
    position: relative;
    z-index: 1101;
    background-color: #fefefe;
    margin: 3% auto;
    padding: 0;
    border: none;
    border-radius: 8px;
    width: 90%;
    max-width: 1000px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

/* Modal Enhancements */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 8px;
    width: 90%;
    max-width: 1000px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    background: linear-gradient(135deg, #0078d4, #106ebe);
    color: white;
}

.modal-header h3 {
    margin: 0;
}

.close {
    color: rgba(255,255,255,0.8);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: white;
}

.modal-body {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

/* Button Styles */
.btn {
    background: linear-gradient(135deg, #0078d4, #106ebe);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
}

.btn:hover {
    background: linear-gradient(135deg, #106ebe, #005a9e);
    transform: translateY(-1px);
}

#topologyModal .modal-content {
    margin: 2% auto;
}

.topology-tooltip {
    max-width: 200px;
    word-wrap: break-word;
}

#topologyCanvas svg {
    border: 1px solid #dee2e6;
    background: #f8f9fa;
}

#topologyLegend {
    font-size: 12px;
    line-height: 1.4;
}

#topologyDetails {
    max-height: 400px;
    overflow-y: auto;
}

#topologyDetails h4 {
    color: #0078d4;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .ip-search-container {
        flex-direction: column;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-controls {
        justify-content: stretch;
    }
    
    .filter-input {
        min-width: auto;
    }
    
    .subscriptions-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
let allNetworkData = {};
let allSubscriptions = [];
let ipReservations = JSON.parse(localStorage.getItem('ipReservations') || '[]');

async function loadDashboard() {
    try {
        // Load subscriptions first
        const subsResponse = await fetch('/api/subscriptions');
        allSubscriptions = await subsResponse.json();
        
        if (allSubscriptions.error) {
            throw new Error(allSubscriptions.error);
        }
        
        // Load network data for all subscriptions
        let totalNetworks = 0;
        let totalSubnets = 0;
        let criticalSubnets = 0;
        let totalUsedIPs = 0;
        let totalCapacityIPs = 0;
        let totalAvailableIPs = 0;
        let alerts = [];
        
        for (const sub of allSubscriptions) {
            try {
                const netResponse = await fetch(`/api/networks/${sub.id}`);
                const netData = await netResponse.json();
                
                if (!netData.error) {
                    allNetworkData[sub.id] = netData;
                    totalNetworks += netData.networks.length;
                    
                    for (const network of netData.networks) {
                        totalSubnets += network.subnets.length;
                        
                        for (const subnet of network.subnets) {
                            totalUsedIPs += subnet.usedIPs;
                            totalCapacityIPs += subnet.usableIPs;
                            totalAvailableIPs += subnet.availableIPs;
                            
                            if (subnet.utilizationPercent >= 90) {
                                criticalSubnets++;
                                alerts.push({
                                    subscription: sub.name,
                                    network: network.name,
                                    subnet: subnet.name,
                                    utilization: subnet.utilizationPercent
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`Error loading networks for ${sub.name}:`, error);
            }
        }
        
        // Calculate reserved IPs
        const totalReservedIPs = calculateReservedIPs();
        const actualAvailableIPs = totalAvailableIPs - totalReservedIPs;
        
        // Update stats
        document.getElementById('totalNetworks').textContent = totalNetworks;
        document.getElementById('totalSubnets').textContent = totalSubnets;
        document.getElementById('criticalSubnets').textContent = criticalSubnets;
        document.getElementById('totalUsedIPs').textContent = totalUsedIPs.toLocaleString();
        
        // Update scope overview
        updateScopeOverview(totalCapacityIPs, totalUsedIPs, totalReservedIPs, actualAvailableIPs);
        
        // Show alerts if any
        if (alerts.length > 0) {
            displayAlerts(alerts);
        }
        
        // Display subscriptions
        displaySubscriptions();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('loading').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #d73502;">
                <h3>Error Loading Dashboard</h3>
                <p>Please check your Azure authentication and try refreshing the page.</p>
                <button class="btn" onclick="window.location.reload()">Retry</button>
            </div>
        `;
    }
}

function updateScopeOverview(total, used, reserved, available) {
    document.getElementById('totalUsed').textContent = used.toLocaleString();
    document.getElementById('totalReserved').textContent = reserved.toLocaleString();
    document.getElementById('totalAvailable').textContent = available.toLocaleString();
    
    // Update progress bar
    const usedPercent = (used / total) * 100;
    const reservedPercent = (reserved / total) * 100;
    const availablePercent = (available / total) * 100;
    
    document.getElementById('usedBar').style.width = `${usedPercent}%`;
    document.getElementById('reservedBar').style.width = `${reservedPercent}%`;
    document.getElementById('availableBar').style.width = `${availablePercent}%`;
    
    // Update CIDR breakdown
    updateActiveCIDRs();
}

function updateActiveCIDRs() {
    const cidrContainer = document.getElementById('activeCIDRs');
    let cidrUsage = [];
    
    // Collect all subnets with usage
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                if (subnet.usedIPs > 0) {
                    cidrUsage.push({
                        cidr: subnet.addressPrefix,
                        usedIPs: subnet.usedIPs,
                        subnetName: subnet.name,
                        networkName: network.name
                    });
                }
            });
        });
    }
    
    // Sort by usage (descending) and take top 6
    cidrUsage.sort((a, b) => b.usedIPs - a.usedIPs);
    const topCIDRs = cidrUsage.slice(0, 6);
    
    let html = '<div class="cidr-header">Active CIDR Blocks</div>';
    
    if (topCIDRs.length === 0) {
        html += '<div class="cidr-loading">No active usage</div>';
    } else {
        topCIDRs.forEach(cidr => {
            html += `
                <div class="cidr-item">
                    <div class="cidr-range">${cidr.cidr}</div>
                    <div class="cidr-usage">${cidr.usedIPs} IPs</div>
                </div>
            `;
        });
        
        // Add total if there are more
        const remaining = cidrUsage.length - topCIDRs.length;
        if (remaining > 0) {
            const remainingIPs = cidrUsage.slice(6).reduce((sum, cidr) => sum + cidr.usedIPs, 0);
            html += `
                <div class="cidr-item" style="font-style: italic; color: #6c757d;">
                    <div>+${remaining} more</div>
                    <div>${remainingIPs} IPs</div>
                </div>
            `;
        }
    }
    
    cidrContainer.innerHTML = html;
}

function calculateReservedIPs() {
    let totalReserved = 0;
    ipReservations.forEach(reservation => {
        totalReserved += calculateCIDRCapacity(reservation.range);
    });
    return totalReserved;
}

function calculateCIDRCapacity(cidr) {
    try {
        if (!cidr.includes('/')) return 1; // Single IP
        const [, prefix] = cidr.split('/');
        return Math.pow(2, 32 - parseInt(prefix));
    } catch {
        return 0;
    }
}

function showCapacityDetails() {
    let html = `
        <h4>üìä Capacity Analysis by Subscription</h4>
        <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        let subUsed = 0, subCapacity = 0;
        
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                subUsed += subnet.usedIPs;
                subCapacity += subnet.usableIPs;
            });
        });
        
        const subUtilization = subCapacity > 0 ? (subUsed / subCapacity) * 100 : 0;
        const statusColor = subUtilization > 75 ? '#dc3545' : subUtilization > 50 ? '#ffc107' : '#28a745';
        
        html += `
            <div style="border: 1px solid #dee2e6; border-left: 4px solid ${statusColor}; padding: 16px; margin: 12px 0; border-radius: 8px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${subscription.name}</strong><br>
                        <small style="color: #666;">
                            ${networkData.networks.length} networks, 
                            ${networkData.networks.reduce((sum, net) => sum + net.subnets.length, 0)} subnets
                        </small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: bold; color: ${statusColor};">
                            ${subUtilization.toFixed(1)}%
                        </div>
                        <div style="font-size: 14px;">
                            ${subUsed.toLocaleString()} / ${subCapacity.toLocaleString()} IPs
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    showCustomModal('Capacity Details', html);
}

function showReservations() {
    document.getElementById('reservationsModal').style.display = 'block';
    loadReservationsList();
}

function closeReservationsModal() {
    document.getElementById('reservationsModal').style.display = 'none';
}

function updateReservationForm() {
    const selectedType = document.querySelector('input[name="reservationType"]:checked').value;
    const rangeLabel = document.getElementById('rangeLabel');
    const rangeHelp = document.getElementById('rangeHelp');
    const rangeInput = document.getElementById('reservationRange');
    const subnetSizeSelector = document.getElementById('subnetSizeSelector');
    
    switch(selectedType) {
        case 'single':
            rangeLabel.textContent = 'IP Address:';
            rangeInput.placeholder = 'e.g., 10.0.1.100';
            rangeHelp.textContent = 'Enter a single IP address like 10.0.1.100';
            subnetSizeSelector.style.display = 'none';
            break;
            
        case 'subnet':
            rangeLabel.textContent = 'Network Address:';
            rangeInput.placeholder = 'e.g., 10.0.1.0';
            rangeHelp.textContent = 'Enter the network address (we\'ll add the subnet size)';
            subnetSizeSelector.style.display = 'block';
            break;
            
        case 'custom':
            rangeLabel.textContent = 'CIDR Block:';
            rangeInput.placeholder = 'e.g., 10.0.1.0/27';
            rangeHelp.textContent = 'Enter a complete CIDR block like 10.0.1.0/27';
            subnetSizeSelector.style.display = 'none';
            break;
    }
    
    updateIPCount();
}

function updateIPCount() {
    const selectedType = document.querySelector('input[name="reservationType"]:checked').value;
    const rangeInput = document.getElementById('reservationRange').value;
    const subnetSize = document.getElementById('subnetSize').value;
    const ipCountText = document.getElementById('ipCountText');
    
    let count = 0;
    let description = '';
    
    switch(selectedType) {
        case 'single':
            count = 1;
            description = '1 IP address';
            break;
            
        case 'subnet':
            count = Math.pow(2, 32 - parseInt(subnetSize));
            description = `${count} IP addresses (/${subnetSize} subnet)`;
            break;
            
        case 'custom':
            if (rangeInput.includes('/')) {
                const prefix = rangeInput.split('/')[1];
                if (prefix && !isNaN(prefix)) {
                    count = Math.pow(2, 32 - parseInt(prefix));
                    description = `${count} IP addresses (/${prefix} subnet)`;
                } else {
                    description = 'Invalid CIDR format';
                }
            } else if (rangeInput) {
                count = 1;
                description = '1 IP address';
            } else {
                description = 'Enter a CIDR block';
            }
            break;
    }
    
    ipCountText.textContent = description;
    ipCountText.style.color = count > 100 ? '#dc3545' : count > 10 ? '#ffc107' : '#28a745';
}

function createReservation() {
    const selectedType = document.querySelector('input[name="reservationType"]:checked').value;
    const rangeInput = document.getElementById('reservationRange').value.trim();
    const subnetSize = document.getElementById('subnetSize').value;
    const purpose = document.getElementById('reservationPurpose').value.trim();
    const owner = document.getElementById('reservationOwner').value.trim();
    const expiry = document.getElementById('reservationExpiry').value;
    
    if (!rangeInput || !purpose || !owner) {
        alert('Please fill in all required fields');
        return;
    }
    
    let finalRange = '';
    
    // Build the final range based on type
    switch(selectedType) {
        case 'single':
            if (!isValidIP(rangeInput)) {
                alert('Please enter a valid IP address (e.g., 10.0.1.100)');
                return;
            }
            finalRange = rangeInput; // No /32 suffix for single IPs
            break;
            
        case 'subnet':
            if (!isValidIP(rangeInput)) {
                alert('Please enter a valid network address (e.g., 10.0.1.0)');
                return;
            }
            finalRange = `${rangeInput}/${subnetSize}`;
            break;
            
        case 'custom':
            if (!isValidCIDR(rangeInput)) {
                alert('Please enter a valid CIDR block (e.g., 10.0.1.0/27)');
                return;
            }
            finalRange = rangeInput;
            break;
    }
    
    const reservation = {
        id: Date.now().toString(),
        range: finalRange,
        type: selectedType,
        purpose: purpose,
        owner: owner,
        expiry: expiry,
        created: new Date().toISOString().split('T')[0]
    };
    
    ipReservations.push(reservation);
    localStorage.setItem('ipReservations', JSON.stringify(ipReservations));
    
    clearReservationForm();
    loadReservationsList();
    loadDashboard();
}

function clearReservationForm() {
    document.getElementById('reservationRange').value = '';
    document.getElementById('reservationPurpose').value = '';
    document.getElementById('reservationOwner').value = '';
    document.getElementById('reservationExpiry').value = '';
    
    // Clear any selected range data from browser
    window.selectedRangeData = null;
    
    // Hide selected range in browser if it's open
    const selectedDiv = document.getElementById('selectedRange');
    if (selectedDiv) {
        selectedDiv.style.display = 'none';
    }
}

function loadReservationsList() {
    const container = document.getElementById('reservationsList');
    
    if (ipReservations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No reservations found</p>';
        return;
    }
    
    let html = '';
    ipReservations.forEach(reservation => {
        const isExpired = reservation.expiry && new Date(reservation.expiry) < new Date();
        const capacityIPs = calculateCIDRCapacity(reservation.range);
        
        html += `
            <div class="reservation-item ${isExpired ? 'expired' : ''}">
                <div class="reservation-header">
                    <div>
                        <div class="reservation-range">${reservation.range}</div>
                        <div style="color: #666; font-size: 13px;">
                            ${capacityIPs.toLocaleString()} IPs | Created: ${reservation.created}
                            ${reservation.expiry ? ` | Expires: ${reservation.expiry}` : ''}
                        </div>
                    </div>
                    <div class="reservation-actions">
                        <button class="btn-small danger" onclick="deleteReservation('${reservation.id}')">Delete</button>
                    </div>
                </div>
                <div style="margin-top: 8px;">
                    <strong>Purpose:</strong> ${reservation.purpose}<br>
                    <strong>Owner:</strong> ${reservation.owner}
                </div>
                ${isExpired ? '<div style="color: #dc3545; font-weight: bold; margin-top: 8px;">‚ö†Ô∏è EXPIRED</div>' : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function deleteReservation(id) {
    if (confirm('Are you sure you want to delete this reservation?')) {
        ipReservations = ipReservations.filter(r => r.id !== id);
        localStorage.setItem('ipReservations', JSON.stringify(ipReservations));
        loadReservationsList();
        loadDashboard(); // Refresh dashboard
    }
}

function showRangeBrowser() {
    console.log('Browse button clicked'); // Debug
    
    const modal = document.getElementById('rangeBrowserModal');
    if (!modal) {
        console.error('Range browser modal not found in DOM');
        alert('Browse functionality not available. Please refresh the page.');
        return;
    }
    
    console.log('Opening modal...'); // Debug
    modal.style.display = 'block';
    
    // Simple test content first
    const treeContainer = document.getElementById('networkTree');
    if (!treeContainer) {
        console.error('Network tree container not found');
        return;
    }
    
    // Start with simple test content
    treeContainer.innerHTML = `
        <div style="padding: 20px;">
            <h4>Debug Info:</h4>
            <p>All network data loaded: ${Object.keys(allNetworkData).length} subscriptions</p>
            <p>All subscriptions: ${allSubscriptions.length} items</p>
            ${Object.keys(allNetworkData).length > 0 ? '<p style="color: green;">‚úì Data is available</p>' : '<p style="color: red;">‚úó No data loaded</p>'}
            <hr>
            <div id="simpleTree">Loading...</div>
        </div>
    `;
    
    // Load simple tree structure after a brief delay
    setTimeout(() => {
        loadSimpleTree();
    }, 100);
}

function loadSimpleTree() {
    const container = document.getElementById('simpleTree');
    if (!container) return;
    
    let html = '<div style="margin-bottom: 16px;"><strong>Your Subscriptions:</strong></div>';
    
    try {
        for (const [subId, networkData] of Object.entries(allNetworkData)) {
            const subscription = allSubscriptions.find(s => s.id === subId);
            if (!subscription) continue;
            
            html += `
                <div style="border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 6px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">üìÅ ${subscription.name}</div>
                    ${networkData.networks.map((network, idx) => {
                        const totalAvailable = network.subnets.reduce((sum, subnet) => sum + subnet.availableIPs, 0);
                        return `
                            <div style="margin-left: 20px; padding: 8px; background: #f8f9fa; margin: 4px 0; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>üåê ${network.name}</strong><br>
                                        <small>${network.location} | ${totalAvailable} IPs available</small>
                                    </div>
                                    <button onclick="selectSimpleRange('${network.name}', '${totalAvailable}')" 
                                            style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Select
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error building tree:', error);
        container.innerHTML = `<div style="color: red;">Error loading network tree: ${error.message}</div>`;
    }
}

function selectSimpleRange(networkName, availableIPs) {
    console.log('Selected network:', networkName);
    
    // Simple range suggestion - just use a /24 block
    const suggestedCIDR = `10.200.${Math.floor(Math.random() * 100)}.0/24`;
    
    document.getElementById('reservationRange').value = suggestedCIDR;
    document.getElementById('reservationPurpose').value = `Reserved space in ${networkName}`;
    
    closeRangeBrowser();
    
    console.log('Range selected and form filled');
}

function closeRangeBrowser() {
    document.getElementById('rangeBrowserModal').style.display = 'none';
}

function isValidCIDR(cidr) {
    // Basic CIDR validation
    if (cidr.includes('/')) {
        const [ip, prefix] = cidr.split('/');
        return isValidIP(ip) && parseInt(prefix) >= 0 && parseInt(prefix) <= 32;
    } else {
        return isValidIP(cidr); // Single IP
    }
}

function isValidIP(ip) {
    const parts = ip.split('.');
    return parts.length === 4 && parts.every(part => 
        /^\d+$/.test(part) && parseInt(part) >= 0 && parseInt(part) <= 255
    );
}

function planCapacity() {
    let html = `
        <h4>üìà Capacity Planning Analysis</h4>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h5>Current Utilization Trends</h5>
    `;
    
    // Calculate utilization by category
    let healthyCount = 0, moderateCount = 0, warningCount = 0, criticalCount = 0;
    
    for (const networkData of Object.values(allNetworkData)) {
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                if (subnet.utilizationPercent < 50) healthyCount++;
                else if (subnet.utilizationPercent < 75) moderateCount++;
                else if (subnet.utilizationPercent < 90) warningCount++;
                else criticalCount++;
            });
        });
    }
    
    html += `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 16px;">
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${healthyCount}</div>
                    <div style="font-size: 12px;">Healthy (0-50%)</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #fd7e14;">${moderateCount}</div>
                    <div style="font-size: 12px;">Moderate (50-75%)</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${warningCount}</div>
                    <div style="font-size: 12px;">Warning (75-90%)</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${criticalCount}</div>
                    <div style="font-size: 12px;">Critical (90%+)</div>
                </div>
            </div>
        </div>
        
        <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h5 style="color: #856404; margin: 0 0 8px 0;">Recommendations</h5>
            <ul style="color: #856404; margin: 0; padding-left: 20px;">
                ${criticalCount > 0 ? `<li><strong>Immediate:</strong> ${criticalCount} subnet(s) need expansion</li>` : ''}
                ${warningCount > 0 ? `<li><strong>Short-term:</strong> Monitor ${warningCount} subnet(s) approaching capacity</li>` : ''}
                <li><strong>Long-term:</strong> Plan for ${Math.ceil((healthyCount + moderateCount + warningCount + criticalCount) * 0.2)} additional subnets based on growth trends</li>
            </ul>
        </div>
    `;
    
    showCustomModal('Capacity Planning', html);
}

function displayAlerts(alerts) {
    const alertsSection = document.getElementById('alertsSection');
    const alertsList = document.getElementById('alertsList');
    
    alertsList.innerHTML = '';
    alerts.forEach(alert => {
        alertsList.innerHTML += `
            <div class="alert-item">
                <div>
                    <strong>${alert.network}/${alert.subnet}</strong> in ${alert.subscription}
                    <br><small>Utilization: ${alert.utilization}%</small>
                </div>
                <span style="color: #dc3545; font-weight: bold;">${alert.utilization}%</span>
            </div>
        `;
    });
    
    alertsSection.style.display = 'block';
}

function displaySubscriptions() {
    const container = document.getElementById('subscriptions');
    container.innerHTML = '';
    
    allSubscriptions.forEach(sub => {
        const networkData = allNetworkData[sub.id];
        const networkCount = networkData ? networkData.networks.length : 0;
        const subnetCount = networkData ? networkData.networks.reduce((sum, net) => sum + net.subnets.length, 0) : 0;
        
        container.innerHTML += `
            <div class="network-card">
                <h4>
                    ${sub.name}
                    <span class="network-status status-enabled">${sub.state}</span>
                </h4>
                <p style="color: #666; font-size: 13px; margin: 8px 0;">
                    ${sub.id}
                </p>
                <div class="network-stats">
                    <div class="stat-item">
                        <div class="stat-number">${networkCount}</div>
                        <div>Networks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${subnetCount}</div>
                        <div>Subnets</div>
                    </div>
                </div>
                <button class="btn" style="width: 100%; margin-top: 16px;" onclick="loadNetworksModal('${sub.id}', '${sub.name}')">
                    View Networks & IP Utilization
                </button>
            </div>
        `;
    });
}

async function searchIP() {
    const searchTerm = document.getElementById('ipSearchInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!searchTerm) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p>Searching across all networks...</p>';
    
    let results = [];
    
    // Search through all network data
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        for (const network of networkData.networks) {
            for (const subnet of network.subnets) {
                // Check if IP is in this subnet's range
                if (isIPInSubnet(searchTerm, subnet.addressPrefix)) {
                    results.push({
                        subscription: subscription.name,
                        network: network.name,
                        subnet: subnet.name,
                        cidr: subnet.addressPrefix,
                        utilization: subnet.utilizationPercent,
                        available: subnet.availableIPs,
                        consumers: subnet.consumers
                    });
                }
            }
        }
    }
    
    // Display results
    if (results.length === 0) {
        resultsDiv.innerHTML = `<p>No networks found containing IP: <strong>${searchTerm}</strong></p>`;
    } else {
        let html = `<h4>Found ${results.length} network(s) containing IP: <strong>${searchTerm}</strong></h4>`;
        results.forEach(result => {
            html += `
                <div style="border-left: 4px solid #0078d4; padding-left: 16px; margin: 16px 0;">
                    <strong>${result.network}/${result.subnet}</strong> in ${result.subscription}<br>
                    <small>CIDR: ${result.cidr} | Utilization: ${result.utilization}% | Available: ${result.available} IPs</small>
                </div>
            `;
        });
        resultsDiv.innerHTML = html;
    }
}

function isIPInSubnet(ip, cidr) {
    // Simple implementation - you might want to use a proper IP library for production
    try {
        if (ip.includes('/')) {
            // If searching for CIDR, do substring match
            return cidr.toLowerCase().includes(ip.toLowerCase());
        }
        
        // Basic IP in subnet check (simplified)
        const [network, prefixLength] = cidr.split('/');
        return cidr.includes(ip.substring(0, ip.lastIndexOf('.')));
    } catch (e) {
        return false;
    }
}

function findAvailableSubnets() {
    document.getElementById('availableSpaceModal').style.display = 'block';
}

function closeAvailableSpaceModal() {
    document.getElementById('availableSpaceModal').style.display = 'none';
}

function findSpaceForIPs() {
    const requiredIPs = parseInt(document.getElementById('requiredIPs').value);
    if (!requiredIPs) return;
    
    let availableSubnets = [];
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        for (const network of networkData.networks) {
            for (const subnet of network.subnets) {
                if (subnet.availableIPs >= requiredIPs) {
                    availableSubnets.push({
                        subscription: subscription.name,
                        network: network.name,
                        subnet: subnet.name,
                        available: subnet.availableIPs,
                        utilization: subnet.utilizationPercent
                    });
                }
            }
        }
    }
    
    // Sort by available IPs (descending)
    availableSubnets.sort((a, b) => b.available - a.available);
    
    let html = `<h4>Found ${availableSubnets.length} subnet(s) with ${requiredIPs}+ available IPs:</h4>`;
    availableSubnets.slice(0, 10).forEach(subnet => {
        html += `
            <div style="border-left: 4px solid #28a745; padding-left: 16px; margin: 12px 0;">
                <strong>${subnet.network}/${subnet.subnet}</strong> in ${subnet.subscription}<br>
                <small>Available: ${subnet.available} IPs | Utilization: ${subnet.utilization}%</small>
            </div>
        `;
    });
    
    document.getElementById('availableSpaceResults').innerHTML = html;
}

function showAllNetworks() {
    let allNetworks = [];
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        networkData.networks.forEach(network => {
            allNetworks.push({
                subscription: subscription.name,
                name: network.name,
                location: network.location,
                resourceGroup: network.resourceGroup,
                addressSpace: network.addressSpace,
                subnetCount: network.subnets.length,
                totalUsedIPs: network.subnets.reduce((sum, subnet) => sum + subnet.usedIPs, 0),
                avgUtilization: network.subnets.reduce((sum, subnet) => sum + subnet.utilizationPercent, 0) / network.subnets.length
            });
        });
    }
    
    let html = `
        <h4>üåê All Virtual Networks (${allNetworks.length})</h4>
        <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    allNetworks.forEach(network => {
        html += `
            <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; margin: 12px 0; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${network.name}</strong><br>
                        <small style="color: #666;">
                            ${network.subscription} | ${network.location} | ${network.resourceGroup}<br>
                            Address: ${network.addressSpace.join(', ')}
                        </small>
                    </div>
                    <div style="text-align: right; font-size: 14px;">
                        <div><strong>${network.subnetCount}</strong> subnets</div>
                        <div><strong>${network.totalUsedIPs}</strong> IPs used</div>
                        <div style="color: ${network.avgUtilization > 75 ? '#dc3545' : network.avgUtilization > 50 ? '#ffc107' : '#28a745'}">
                            ${network.avgUtilization.toFixed(1)}% avg usage
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    showCustomModal('All Virtual Networks', html);
}

function showAllSubnets() {
    let allSubnets = [];
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                allSubnets.push({
                    subscription: subscription.name,
                    network: network.name,
                    name: subnet.name,
                    addressPrefix: subnet.addressPrefix,
                    utilization: subnet.utilizationPercent,
                    usedIPs: subnet.usedIPs,
                    availableIPs: subnet.availableIPs,
                    status: subnet.utilizationStatus
                });
            });
        });
    }
    
    // Sort by utilization (descending)
    allSubnets.sort((a, b) => b.utilization - a.utilization);
    
    let html = `
        <h4>üìä All Subnets (${allSubnets.length}) - Sorted by Utilization</h4>
        <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    allSubnets.forEach(subnet => {
        const statusColor = getStatusColor(subnet.status);
        html += `
            <div style="border: 1px solid #dee2e6; border-left: 4px solid ${statusColor}; border-radius: 8px; padding: 16px; margin: 12px 0; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${subnet.network}/${subnet.name}</strong><br>
                        <small style="color: #666;">
                            ${subnet.subscription}<br>
                            CIDR: ${subnet.addressPrefix}
                        </small>
                    </div>
                    <div style="text-align: right; font-size: 14px;">
                        <div style="color: ${statusColor}; font-weight: bold; font-size: 16px;">
                            ${subnet.utilization.toFixed(1)}%
                        </div>
                        <div><strong>${subnet.usedIPs}</strong> used</div>
                        <div><strong>${subnet.availableIPs}</strong> available</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    showCustomModal('All Subnets by Utilization', html);
}

function showCriticalSubnets() {
    let criticalSubnets = [];
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                if (subnet.utilizationPercent >= 90) {
                    criticalSubnets.push({
                        subscription: subscription.name,
                        network: network.name,
                        name: subnet.name,
                        addressPrefix: subnet.addressPrefix,
                        utilization: subnet.utilizationPercent,
                        usedIPs: subnet.usedIPs,
                        availableIPs: subnet.availableIPs,
                        consumers: subnet.consumers
                    });
                }
            });
        });
    }
    
    let html = '';
    
    if (criticalSubnets.length === 0) {
        html = `
            <div style="text-align: center; padding: 40px; color: #28a745;">
                <div style="font-size: 3em; margin-bottom: 16px;">‚úÖ</div>
                <h4>No Critical Usage Found!</h4>
                <p>All subnets are below 90% utilization. Great job managing your IP space!</p>
            </div>
        `;
    } else {
        html = `
            <h4>üö® Critical Subnets (${criticalSubnets.length}) - Immediate Attention Required</h4>
            <div style="max-height: 400px; overflow-y: auto;">
        `;
        
        criticalSubnets.forEach(subnet => {
            html += `
                <div style="border: 1px solid #dc3545; border-left: 4px solid #dc3545; border-radius: 8px; padding: 16px; margin: 12px 0; background: #fff5f5;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong style="color: #dc3545;">${subnet.network}/${subnet.name}</strong><br>
                            <small style="color: #666;">
                                ${subnet.subscription}<br>
                                CIDR: ${subnet.addressPrefix}
                            </small>
                            ${subnet.consumers.length > 0 ? `
                                <div style="margin-top: 8px; font-size: 13px;">
                                    <strong>Top consumers:</strong> ${subnet.consumers.slice(0, 3).join(', ')}
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #dc3545; font-weight: bold; font-size: 18px;">
                                ${subnet.utilization.toFixed(1)}%
                            </div>
                            <div style="color: #dc3545;">Only ${subnet.availableIPs} IPs left!</div>
                            <div style="margin-top: 8px;">
                                <button class="btn" style="background: #dc3545; font-size: 12px; padding: 6px 12px;" 
                                        onclick="alert('Expansion planning coming soon!')">
                                    Plan Expansion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    showCustomModal('Critical Usage Analysis', html);
}

function showTopIPConsumers() {
    // Organize data by resource group hierarchy
    let resourceGroups = {};
    let totalIPs = 0;
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        networkData.networks.forEach(network => {
            const resourceGroup = network.resourceGroup || 'Unknown Resource Group';
            
            if (!resourceGroups[resourceGroup]) {
                resourceGroups[resourceGroup] = {
                    name: resourceGroup,
                    subscription: subscription.name,
                    subscriptionId: subId,
                    totalIPs: 0,
                    networks: {}
                };
            }
            
            if (!resourceGroups[resourceGroup].networks[network.name]) {
                resourceGroups[resourceGroup].networks[network.name] = {
                    name: network.name,
                    location: network.location,
                    addressSpace: network.addressSpace,
                    totalIPs: 0,
                    subnets: []
                };
            }
            
            network.subnets.forEach(subnet => {
                if (subnet.usedIPs > 0) {
                    const subnetData = {
                        name: subnet.name,
                        addressPrefix: subnet.addressPrefix,
                        usedIPs: subnet.usedIPs,
                        availableIPs: subnet.availableIPs,
                        utilization: subnet.utilizationPercent,
                        consumers: subnet.consumers || [],
                        utilizationStatus: subnet.utilizationStatus
                    };
                    
                    resourceGroups[resourceGroup].networks[network.name].subnets.push(subnetData);
                    resourceGroups[resourceGroup].networks[network.name].totalIPs += subnet.usedIPs;
                    resourceGroups[resourceGroup].totalIPs += subnet.usedIPs;
                    totalIPs += subnet.usedIPs;
                }
            });
        });
    }
    
    // Sort resource groups by total IP usage
    const sortedResourceGroups = Object.values(resourceGroups)
        .filter(rg => rg.totalIPs > 0)
        .sort((a, b) => b.totalIPs - a.totalIPs);
    
    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4>üè¢ IP Consumption by Resource Group</h4>
            <div style="background: #e8f4fd; padding: 8px 16px; border-radius: 6px;">
                <strong>${totalIPs.toLocaleString()} Total IPs in Use</strong>
            </div>
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
    `;
    
    sortedResourceGroups.forEach((rg, rgIndex) => {
        const rgId = `rg-${rgIndex}`;
        html += `
            <div style="border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 16px; background: white;">
                <!-- Resource Group Header -->
                <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 16px; border-radius: 8px 8px 0 0; cursor: pointer;" 
                     onclick="toggleBrowserItem('${rgId}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="toggle-${rgId}" style="font-family: monospace;">‚ñº</span>
                                <strong style="font-size: 16px;">üìÅ ${rg.name}</strong>
                            </div>
                            <small style="color: #666; margin-left: 20px;">${rg.subscription}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #0078d4;">
                                ${rg.totalIPs.toLocaleString()} IPs
                            </div>
                            <small style="color: #666;">${Object.keys(rg.networks).length} networks</small>
                        </div>
                    </div>
                </div>
                
                <!-- Networks Content -->
                <div id="content-${rgId}" style="padding: 0;">
        `;
        
        // Sort networks by IP usage
        const sortedNetworks = Object.values(rg.networks)
            .sort((a, b) => b.totalIPs - a.totalIPs);
        
        sortedNetworks.forEach((network, netIndex) => {
            const netId = `net-${rgIndex}-${netIndex}`;
            html += `
                <div style="border-top: 1px solid #f1f3f4;">
                    <!-- Network Header -->
                    <div style="padding: 12px 20px; background: #fbfcfd; cursor: pointer;" 
                         onclick="toggleBrowserItem('${netId}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span id="toggle-${netId}" style="font-family: monospace;">‚ñº</span>
                                    <strong>üåê ${network.name}</strong>
                                </div>
                                <small style="color: #666; margin-left: 20px;">
                                    ${network.location} | ${network.addressSpace?.join(', ') || 'N/A'}
                                </small>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #0078d4;">
                                    ${network.totalIPs.toLocaleString()} IPs
                                </div>
                                <small style="color: #666;">${network.subnets.length} subnets</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subnets Content -->
                    <div id="content-${netId}" style="padding: 0;">
            `;
            
            // Sort subnets by IP usage
            network.subnets.sort((a, b) => b.usedIPs - a.usedIPs);
            
            network.subnets.forEach((subnet, subIndex) => {
                const statusColor = getStatusColor(subnet.utilizationStatus);
                const subnetId = `subnet-${rgIndex}-${netIndex}-${subIndex}`;
                
                html += `
                    <div style="border-top: 1px solid #f8f9fa; padding: 12px 40px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <strong>üîπ ${subnet.name}</strong>
                                    <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${subnet.utilization.toFixed(1)}%
                                    </span>
                                </div>
                                <small style="color: #666; margin-top: 4px;">
                                    ${subnet.addressPrefix} | Used: ${subnet.usedIPs} | Available: ${subnet.availableIPs}
                                </small>
                            </div>
                            <div style="text-align: right;">
                                <button onclick="reserveFromConsumers('${subnet.addressPrefix}')" 
                                        class="btn" style="font-size: 11px; padding: 4px 8px;">
                                    Reserve IP
                                </button>
                            </div>
                        </div>
                        
                        <!-- Device/Resource List -->
                        ${subnet.consumers.length > 0 ? `
                            <div style="margin-top: 8px;">
                                <div style="font-weight: 600; font-size: 12px; color: #495057; margin-bottom: 6px; cursor: pointer;" 
                                     onclick="toggleConsumers('${subnetId}')">
                                    <span id="toggle-consumers-${subnetId}">‚ñº</span> 
                                    ${subnet.consumers.length} Resources Consuming IPs:
                                </div>
                                <div id="consumers-${subnetId}" style="margin-left: 12px;">
                                    ${subnet.consumers.slice(0, 8).map((consumer, idx) => `
                                        <div style="padding: 4px 8px; margin: 2px 0; background: #f8f9fa; border-radius: 4px; font-size: 11px; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="color: #0078d4;">üíª</span> ${consumer}
                                            </div>
                                            <small style="color: #666;">~1 IP</small>
                                        </div>
                                    `).join('')}
                                    ${subnet.consumers.length > 8 ? `
                                        <div style="text-align: center; margin: 8px 0; color: #666; font-size: 11px;">
                                            ... and ${subnet.consumers.length - 8} more resources
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : '<div style="color: #666; font-size: 12px; margin-top: 8px;">No specific resources identified</div>'}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    showCustomModal('Top IP Consumers by Resource Group', html);
}

// Helper functions for the hierarchical view
function toggleBrowserItem(itemId) {
    const content = document.getElementById(`content-${itemId}`);
    const toggle = document.getElementById(`toggle-${itemId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

function toggleNetwork(netId) {
    const content = document.getElementById(`content-${netId}`);
    const toggle = document.getElementById(`toggle-${netId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

function toggleConsumers(subnetId) {
    const content = document.getElementById(`consumers-${subnetId}`);
    const toggle = document.getElementById(`toggle-consumers-${subnetId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

function reserveFromConsumers(cidr) {
    // Close current modal
    closeModal();
    
    // Open reservations modal
    showReservations();
    
    // Pre-fill with a suggested IP from this subnet
    setTimeout(() => {
        const baseIP = cidr.split('/')[0];
        const lastOctet = parseInt(baseIP.split('.')[3]);
        const suggestedIP = baseIP.split('.').slice(0, 3).join('.') + '.' + (lastOctet + 10);
        
        document.getElementById('reservationRange').value = suggestedIP;
        document.getElementById('reservationPurpose').value = `Reserved IP in ${cidr}`;
        
        // Ensure single IP is selected
        document.querySelector('input[name="reservationType"][value="single"]').checked = true;
        updateReservationForm();
    }, 100);
}

function showCustomModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('networkModal').style.display = 'block';
}

// Existing modal functions
async function loadNetworksModal(subscriptionId, subscriptionName) {
    document.getElementById('modalTitle').textContent = `Networks in ${subscriptionName}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <p>Loading networks and IP utilization for ${subscriptionName}...</p>
        </div>
    `;
    document.getElementById('networkModal').style.display = 'block';
    
    const networkData = allNetworkData[subscriptionId];
    if (networkData) {
        displayNetworkData(networkData);
    }
}

function displayNetworkData(data) {
    // Use your existing network display logic here
    let html = '';
    
    if (!data.networks || data.networks.length === 0) {
        html = '<p>No virtual networks found in this subscription.</p>';
    } else {
        data.networks.forEach(network => {
            html += `
                <div class="network-card">
                    <h3>üåê ${network.name}</h3>
                    <p><strong>Location:</strong> ${network.location}</p>
                    <p><strong>Resource Group:</strong> ${network.resourceGroup || 'N/A'}</p>
                    <p><strong>Address Space:</strong> ${network.addressSpace?.join(', ') || 'N/A'}</p>
                    
                    <h4>üìã Subnets & IP Utilization:</h4>
            `;
            
            if (network.subnets && network.subnets.length > 0) {
                network.subnets.forEach(subnet => {
                    const statusColor = getStatusColor(subnet.utilizationStatus);
                    const utilizationBar = getUtilizationBar(subnet.utilizationPercent, statusColor);
                    
                    html += `
                        <div class="subnet" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>üîπ ${subnet.name}</strong> 
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    ${subnet.utilizationPercent}% Used
                                </span>
                            </div>
                            <div style="margin-bottom: 8px; font-size: 14px; color: #666;">
                                <strong>CIDR:</strong> ${subnet.addressPrefix} | 
                                <strong>Used:</strong> ${subnet.usedIPs} | 
                                <strong>Available:</strong> ${subnet.availableIPs} | 
                                <strong>Total Usable:</strong> ${subnet.usableIPs}
                            </div>
                            ${utilizationBar}
                            ${subnet.consumers && subnet.consumers.length > 0 ? 
                                `<div style="margin-top: 8px; font-size: 13px; color: #495057;">
                                    <strong>IP Consumers:</strong> ${subnet.consumers.join(', ')}
                                </div>` : ''
                            }
                        </div>
                    `;
                });
            } else {
                html += '<div style="padding: 16px; color: #666;">No subnets found in this virtual network</div>';
            }
            
            html += '</div>';
        });
    }
    
    document.getElementById('modalBody').innerHTML = html;
}

function getStatusColor(status) {
    switch(status?.toLowerCase()) {
        case 'critical': return '#dc3545';
        case 'warning': return '#ffc107';
        case 'moderate': return '#fd7e14';
        case 'healthy': return '#28a745';
        default: return '#6c757d';
    }
}

function getUtilizationBar(percent, color) {
    return `
        <div style="width: 100%; height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
            <div style="width: ${Math.min(percent, 100)}%; height: 100%; background: ${color}; transition: width 0.5s ease-in-out;"></div>
        </div>
    `;
}

function closeModal() {
    document.getElementById('networkModal').style.display = 'none';
}

// Event listeners
window.onclick = function(event) {
    const networkModal = document.getElementById('networkModal');
    const spaceModal = document.getElementById('availableSpaceModal');
    if (event.target == networkModal) {
        closeModal();
    } else if (event.target == spaceModal) {
        closeAvailableSpaceModal();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
        closeAvailableSpaceModal();
    }
});

// Search functionality
document.getElementById('ipSearchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        searchIP();
    }
});

function showIPConflicts() {
    let conflicts = [];
    let allRanges = [];
    
    // Collect all IP ranges from networks and reservations
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                allRanges.push({
                    type: 'subnet',
                    range: subnet.addressPrefix,
                    source: `${network.name}/${subnet.name}`,
                    subscription: subscription.name
                });
            });
        });
    }
    
    // Add reservations
    ipReservations.forEach(reservation => {
        allRanges.push({
            type: 'reservation',
            range: reservation.range.includes('/') ? reservation.range : reservation.range + '/32',
            source: reservation.purpose,
            owner: reservation.owner
        });
    });
    
    // Simple conflict detection (overlapping ranges)
    for (let i = 0; i < allRanges.length; i++) {
        for (let j = i + 1; j < allRanges.length; j++) {
            if (rangesOverlap(allRanges[i].range, allRanges[j].range)) {
                conflicts.push({
                    range1: allRanges[i],
                    range2: allRanges[j]
                });
            }
        }
    }
    
    let html = `<h4>‚ö° IP Conflict Analysis</h4>`;
    
    if (conflicts.length === 0) {
        html += `
            <div style="text-align: center; padding: 40px; color: #28a745;">
                <div style="font-size: 3em; margin-bottom: 16px;">‚úÖ</div>
                <h4>No IP Conflicts Found!</h4>
                <p>All your IP ranges are properly isolated with no overlaps.</p>
            </div>
        `;
    } else {
        html += `
            <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <strong style="color: #856404;">Found ${conflicts.length} potential conflict(s)</strong>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
        `;
        
        conflicts.forEach((conflict, index) => {
            html += `
                <div style="border: 1px solid #dc3545; border-left: 4px solid #dc3545; border-radius: 8px; padding: 16px; margin: 12px 0; background: #fff5f5;">
                    <div style="font-weight: bold; color: #dc3545; margin-bottom: 8px;">Conflict #${index + 1}</div>
                    <div style="margin-bottom: 8px;">
                        <strong>${conflict.range1.range}</strong> (${conflict.range1.type})<br>
                        <small>Source: ${conflict.range1.source}${conflict.range1.subscription ? ` - ${conflict.range1.subscription}` : ''}</small>
                    </div>
                    <div style="text-align: center; margin: 8px 0; color: #dc3545;">‚ö†Ô∏è OVERLAPS WITH ‚ö†Ô∏è</div>
                    <div>
                        <strong>${conflict.range2.range}</strong> (${conflict.range2.type})<br>
                        <small>Source: ${conflict.range2.source}${conflict.range2.subscription ? ` - ${conflict.range2.subscription}` : ''}</small>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    showCustomModal('IP Conflict Check', html);
}

function rangesOverlap(range1, range2) {
    // Simple overlap check - in production you'd want a more sophisticated IP range library
    try {
        if (range1 === range2) return true;
        // Basic check for same network prefix
        const base1 = range1.split('/')[0].split('.').slice(0, 2).join('.');
        const base2 = range2.split('/')[0].split('.').slice(0, 2).join('.');
        return base1 === base2;
    } catch (e) {
        return false;
    }
}

function exportReport() {
    // Collect all data
    let totalNetworks = 0;
    let totalSubnets = 0;
    let totalUsedIPs = 0;
    let totalAvailableIPs = 0;
    let csvData = [];
    
    // Add header
    csvData.push(['Subscription', 'Network', 'Subnet', 'CIDR', 'Used IPs', 'Available IPs', 'Utilization %', 'Status']);
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        totalNetworks += networkData.networks.length;
        
        networkData.networks.forEach(network => {
            totalSubnets += network.subnets.length;
            
            network.subnets.forEach(subnet => {
                totalUsedIPs += subnet.usedIPs;
                totalAvailableIPs += subnet.availableIPs;
                
                csvData.push([
                    subscription.name,
                    network.name,
                    subnet.name,
                    subnet.addressPrefix,
                    subnet.usedIPs,
                    subnet.availableIPs,
                    subnet.utilizationPercent.toFixed(1),
                    subnet.utilizationStatus || 'healthy'
                ]);
            });
        });
    }
    
    // Add reservations section
    if (ipReservations.length > 0) {
        csvData.push(['', '', '', '', '', '', '', '']); // Empty row
        csvData.push(['=== IP RESERVATIONS ===', '', '', '', '', '', '', '']);
        csvData.push(['Purpose', 'Owner', 'Range', 'Created', 'Expires', 'IPs Reserved', '', '']);
        
        ipReservations.forEach(reservation => {
            csvData.push([
                reservation.purpose,
                reservation.owner,
                reservation.range,
                reservation.created,
                reservation.expiry || 'No expiration',
                calculateCIDRCapacity(reservation.range),
                '',
                ''
            ]);
        });
    }
    
    // Convert to CSV
    const csvContent = csvData.map(row => 
        row.map(field => `"${field}"`).join(',')
    ).join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `azure-ipam-report-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Show confirmation
    const html = `
        <h4>üìã Export Complete</h4>
        <div style="text-align: center; padding: 40px; color: #28a745;">
            <div style="font-size: 3em; margin-bottom: 16px;">‚úÖ</div>
            <h4>Report Downloaded Successfully!</h4>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin: 20px 0; text-align: left;">
                <strong>Report Summary:</strong><br>
                ‚Ä¢ ${totalNetworks} Virtual Networks<br>
                ‚Ä¢ ${totalSubnets} Subnets<br>
                ‚Ä¢ ${totalUsedIPs.toLocaleString()} IPs in use<br>
                ‚Ä¢ ${totalAvailableIPs.toLocaleString()} IPs available<br>
                ‚Ä¢ ${ipReservations.length} Active reservations<br>
            </div>
            <p>Check your Downloads folder for the CSV file.</p>
        </div>
    `;
    
    showCustomModal('Export Report', html);
}

function showGrowthTrends() {
    // Calculate growth trends and projections
    let utilizationStats = [];
    let totalCapacity = 0;
    let totalUsed = 0;
    
    for (const networkData of Object.values(allNetworkData)) {
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                utilizationStats.push(subnet.utilizationPercent);
                totalCapacity += subnet.usableIPs;
                totalUsed += subnet.usedIPs;
            });
        });
    }
    
    const avgUtilization = utilizationStats.reduce((sum, util) => sum + util, 0) / utilizationStats.length;
    const highUtilizationCount = utilizationStats.filter(util => util > 75).length;
    
    // Simple growth projection (assumes current growth rate continues)
    const currentUtilization = (totalUsed / totalCapacity) * 100;
    const monthlyGrowthRate = 2.5; // Assume 2.5% monthly growth
    const projectedUtilization3Months = currentUtilization + (monthlyGrowthRate * 3);
    const projectedUtilization6Months = currentUtilization + (monthlyGrowthRate * 6);
    const projectedUtilization12Months = currentUtilization + (monthlyGrowthRate * 12);
    
    const html = `
        <h4>üìà Growth Analysis & Trends</h4>
        
        <!-- Current State -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h5>Current Utilization Overview</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                <div style="text-align: center; padding: 16px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${currentUtilization.toFixed(1)}%</div>
                    <div>Overall Utilization</div>
                </div>
                <div style="text-align: center; padding: 16px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${avgUtilization.toFixed(1)}%</div>
                    <div>Average per Subnet</div>
                </div>
                <div style="text-align: center; padding: 16px; background: white; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: ${highUtilizationCount > 0 ? '#dc3545' : '#28a745'};">${highUtilizationCount}</div>
                    <div>Subnets >75% Full</div>
                </div>
            </div>
        </div>
        
        <!-- Growth Projections -->
        <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h5>Projected Growth (assuming ${monthlyGrowthRate}% monthly growth)</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px;">
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 18px; font-weight: bold; color: ${projectedUtilization3Months > 80 ? '#dc3545' : '#0078d4'};">${projectedUtilization3Months.toFixed(1)}%</div>
                    <div style="font-size: 12px;">3 Months</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 18px; font-weight: bold; color: ${projectedUtilization6Months > 80 ? '#dc3545' : '#0078d4'};">${projectedUtilization6Months.toFixed(1)}%</div>
                    <div style="font-size: 12px;">6 Months</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                    <div style="font-size: 18px; font-weight: bold; color: ${projectedUtilization12Months > 80 ? '#dc3545' : '#0078d4'};">${projectedUtilization12Months.toFixed(1)}%</div>
                    <div style="font-size: 12px;">12 Months</div>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div style="background: #fff3cd; padding: 16px; border-radius: 8px;">
            <h5 style="color: #856404; margin: 0 0 12px 0;">Capacity Planning Recommendations</h5>
            <ul style="color: #856404; margin: 0; padding-left: 20px;">
                ${projectedUtilization6Months > 80 ? '<li><strong>High Priority:</strong> Plan additional capacity within 6 months</li>' : ''}
                ${highUtilizationCount > 0 ? `<li><strong>Immediate:</strong> Review ${highUtilizationCount} subnet(s) with >75% utilization</li>` : ''}
                <li><strong>Monitoring:</strong> Review utilization monthly to validate growth assumptions</li>
                <li><strong>Planning:</strong> Consider expanding address space if utilization exceeds 70%</li>
                ${projectedUtilization12Months > 90 ? '<li><strong>Critical:</strong> Major capacity expansion needed within 12 months</li>' : ''}
            </ul>
        </div>
    `;
    
    showCustomModal('Growth Analysis', html);
}

// Universal Network Browser Functions
let browserContext = null;
let browserData = [];

function showNetworkBrowser(context = 'general') {
    browserContext = context;
    const modal = document.getElementById('universalBrowserModal');
    const title = document.getElementById('browserModalTitle');
    
    // Set title based on context
    switch(context) {
        case 'search':
            title.textContent = 'üîç Browse Networks to Search';
            break;
        case 'reservation':
            title.textContent = 'üîí Browse Networks for Reservation';
            break;
        case 'analysis':
            title.textContent = 'üìä Browse Networks for Analysis';
            break;
        default:
            title.textContent = 'üóÇÔ∏è Browse Networks';
    }
    
    modal.style.display = 'block';
    loadUniversalBrowserTree();
}

function closeUniversalBrowser() {
    document.getElementById('universalBrowserModal').style.display = 'none';
    browserContext = null;
}

function loadUniversalBrowserTree() {
    const container = document.getElementById('universalBrowserTree');
    browserData = []; // Reset browser data
    
    let html = '<div style="margin-bottom: 16px;"><strong>Your Azure Infrastructure:</strong></div>';
    
    try {
        for (const [subId, networkData] of Object.entries(allNetworkData)) {
            const subscription = allSubscriptions.find(s => s.id === subId);
            if (!subscription) continue;
            
            // Calculate subscription stats
            let totalUsed = 0;
            let totalCapacity = 0;
            let criticalCount = 0;
            
            networkData.networks.forEach(network => {
                network.subnets.forEach(subnet => {
                    totalUsed += subnet.usedIPs;
                    totalCapacity += subnet.usableIPs;
                    if (subnet.utilizationPercent >= 90) criticalCount++;
                });
            });
            
            const subUtilization = totalCapacity > 0 ? (totalUsed / totalCapacity) * 100 : 0;
            const subData = {
                type: 'subscription',
                id: subId,
                name: subscription.name,
                utilization: subUtilization,
                data: subscription,
                networks: networkData.networks.length,
                subnets: networkData.networks.reduce((sum, net) => sum + net.subnets.length, 0),
                criticalCount: criticalCount
            };
            browserData.push(subData);
            
            const subId_safe = `sub-${subId.replace(/[^a-zA-Z0-9]/g, '')}`;
            html += `
                <div class="browser-item subscription-item" data-type="subscription">
                    <div class="browser-header" onclick="toggleBrowserItem('${subId_safe}')" style="cursor: pointer; padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span id="toggle-${subId_safe}" style="font-family: monospace;">‚ñ∂</span>
                                    <strong onclick="showBrowserDetails('${subData.type}', '${subId}')" style="color: #0078d4; cursor: pointer;">
                                        üìÅ ${subscription.name}
                                    </strong>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                ${criticalCount > 0 ? `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">${criticalCount} Critical</span>` : ''}
                                <span style="font-size: 12px; color: #666;">${subUtilization.toFixed(1)}%</span>
                                <span style="background: ${getUtilizationColor(subUtilization)}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>
                            </div>
                        </div>
                    </div>
                    <div id="content-${subId_safe}" style="display: none; margin-left: 20px;">
            `;
            
            networkData.networks.forEach((network, netIndex) => {
                let netUsed = 0;
                let netCapacity = 0;
                let netCritical = 0;
                
                network.subnets.forEach(subnet => {
                    netUsed += subnet.usedIPs;
                    netCapacity += subnet.usableIPs;
                    if (subnet.utilizationPercent >= 90) netCritical++;
                });
                
                const netUtilization = netCapacity > 0 ? (netUsed / netCapacity) * 100 : 0;
                const netData = {
                    type: 'vnet',
                    id: `${subId}-${netIndex}`,
                    name: network.name,
                    utilization: netUtilization,
                    data: network,
                    subnets: network.subnets.length,
                    criticalCount: netCritical,
                    subscriptionName: subscription.name
                };
                browserData.push(netData);
                
                const netId_safe = `net-${subId.replace(/[^a-zA-Z0-9]/g, '')}-${netIndex}`;
                html += `
                    <div class="browser-item vnet-item" data-type="vnet">
                        <div class="browser-header" onclick="toggleBrowserItem('${netId_safe}')" style="cursor: pointer; padding: 10px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span id="toggle-${netId_safe}" style="font-family: monospace;">‚ñ∂</span>
                                        <strong onclick="showBrowserDetails('${netData.type}', '${netData.id}')" style="color: #106ebe; cursor: pointer;">
                                            üåê ${network.name}
                                        </strong>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    ${netCritical > 0 ? `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">${netCritical} Critical</span>` : ''}
                                    <span style="font-size: 12px; color: #666;">${netUtilization.toFixed(1)}%</span>
                                    <span style="background: ${getUtilizationColor(netUtilization)}; width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px; margin-left: 20px;">
                                ${network.location} | ${network.subnets.length} subnets
                            </div>
                        </div>
                        <div id="content-${netId_safe}" style="display: none; margin-left: 20px;">
                `;
                
                network.subnets.forEach((subnet, subnetIndex) => {
                    const subnetData = {
                        type: 'subnet',
                        id: `${subId}-${netIndex}-${subnetIndex}`,
                        name: subnet.name,
                        utilization: subnet.utilizationPercent,
                        data: subnet,
                        usedIPs: subnet.usedIPs,
                        availableIPs: subnet.availableIPs,
                        cidr: subnet.addressPrefix,
                        networkName: network.name,
                        subscriptionName: subscription.name
                    };
                    browserData.push(subnetData);
                    
                    html += `
                        <div class="browser-item subnet-item" data-type="subnet" onclick="showBrowserDetails('${subnetData.type}', '${subnetData.id}')" 
                             style="cursor: pointer; padding: 8px; background: white; border-left: 4px solid ${getUtilizationColor(subnet.utilizationPercent)}; 
                                    margin: 4px 0; border-radius: 3px; transition: background 0.2s;"
                             onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 13px;">üîπ ${subnet.name}</strong>
                                    <div style="font-size: 11px; color: #666; font-family: monospace;">${subnet.addressPrefix}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 11px; color: ${getUtilizationColor(subnet.utilizationPercent)}; font-weight: bold;">
                                        ${subnet.utilizationPercent.toFixed(1)}%
                                    </div>
                                    <div style="font-size: 10px; color: #666;">${subnet.usedIPs}/${subnet.usedIPs + subnet.availableIPs}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div></div>';
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error building browser tree:', error);
        container.innerHTML = `<div style="color: red;">Error loading network browser: ${error.message}</div>`;
    }
}

function toggleBrowserItem(itemId) {
    const content = document.getElementById(`content-${itemId}`);
    const toggle = document.getElementById(`toggle-${itemId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

function showBrowserDetails(type, id) {
    const panel = document.getElementById('browserDetailsPanel');
    const item = browserData.find(item => item.type === type && item.id === id);
    
    if (!item) {
        panel.innerHTML = '<div style="text-align: center; color: red; margin-top: 40px;">Item not found</div>';
        return;
    }
    
    let html = `<div style="border-bottom: 1px solid #dee2e6; padding-bottom: 12px; margin-bottom: 16px;">`;
    
    if (type === 'subscription') {
        html += `
            <h4 style="color: #0078d4; margin: 0;">üìÅ ${item.name}</h4>
            <p style="color: #666; font-size: 13px; margin: 4px 0 0 0;">Azure Subscription</p>
        </div>
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>Networks:</strong> ${item.networks}</div>
                    <div><strong>Subnets:</strong> ${item.subnets}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(item.utilization)}">${item.utilization.toFixed(1)}%</span></div>
                    <div><strong>Critical:</strong> <span style="color: ${item.criticalCount > 0 ? '#dc3545' : '#28a745'}">${item.criticalCount}</span></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Subscription Details:</strong>
            <div style="font-size: 12px; margin-top: 8px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                <div><strong>State:</strong> ${item.data.state}</div>
                <div style="margin-top: 4px;"><strong>ID:</strong></div>
                <div style="font-family: monospace; font-size: 10px; word-break: break-all;">${item.data.id}</div>
            </div>
        </div>
        `;
    } else if (type === 'vnet') {
        html += `
            <h4 style="color: #106ebe; margin: 0;">üåê ${item.name}</h4>
            <p style="color: #666; font-size: 13px; margin: 4px 0 0 0;">Virtual Network in ${item.subscriptionName}</p>
        </div>
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>Location:</strong> ${item.data.location}</div>
                    <div><strong>Subnets:</strong> ${item.subnets}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(item.utilization)}">${item.utilization.toFixed(1)}%</span></div>
                    <div><strong>Critical:</strong> <span style="color: ${item.criticalCount > 0 ? '#dc3545' : '#28a745'}">${item.criticalCount}</span></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Network Details:</strong>
            <div style="font-size: 12px; margin-top: 8px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                <div><strong>Resource Group:</strong> ${item.data.resourceGroup || 'N/A'}</div>
                <div style="margin-top: 4px;"><strong>Address Space:</strong></div>
                <div style="font-family: monospace;">${item.data.addressSpace?.join(', ') || 'N/A'}</div>
            </div>
        </div>
        `;
    } else if (type === 'subnet') {
        html += `
            <h4 style="color: #28a745; margin: 0;">üîπ ${item.name}</h4>
            <p style="color: #666; font-size: 13px; margin: 4px 0 0 0;">Subnet in ${item.networkName}</p>
        </div>
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>Used IPs:</strong> ${item.usedIPs}</div>
                    <div><strong>Available:</strong> ${item.availableIPs}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(item.utilization)}">${item.utilization.toFixed(1)}%</span></div>
                    <div><strong>Total:</strong> ${item.usedIPs + item.availableIPs}</div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Subnet Details:</strong>
            <div style="font-size: 12px; margin-top: 8px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                <div><strong>CIDR:</strong></div>
                <div style="font-family: monospace; font-weight: bold;">${item.cidr}</div>
            </div>
        </div>
        ${item.data.consumers && item.data.consumers.length > 0 ? `
            <div style="margin-bottom: 16px;">
                <strong style="font-size: 13px;">IP Consumers (${item.data.consumers.length}):</strong>
                <div style="max-height: 120px; overflow-y: auto; margin-top: 8px;">
                    ${item.data.consumers.slice(0, 10).map(consumer => 
                        `<div style="font-size: 11px; padding: 4px; background: #f8f9fa; margin: 2px 0; border-radius: 3px;">üíª ${consumer}</div>`
                    ).join('')}
                    ${item.data.consumers.length > 10 ? `<div style="text-align: center; color: #666; font-size: 11px; margin: 8px 0;">... and ${item.data.consumers.length - 10} more</div>` : ''}
                </div>
            </div>
        ` : ''}
        `;
    }
    
    // Add context-specific actions
    html += '<div style="border-top: 1px solid #dee2e6; padding-top: 16px;">';
    html += '<strong style="font-size: 13px;">Quick Actions:</strong><div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">';
    
    if (type === 'subnet') {
        html += `<button onclick="browserAction('reserve', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px;">Reserve IP</button>`;
        html += `<button onclick="browserAction('analyze', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px; background: #28a745;">Analyze</button>`;
        if (browserContext === 'search') {
            html += `<button onclick="browserAction('search', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px; background: #ffc107;">Search Here</button>`;
        }
    }
    
    if (type === 'vnet') {
        html += `<button onclick="browserAction('details', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px;">View Details</button>`;
        html += `<button onclick="browserAction('analyze', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px; background: #28a745;">Analyze</button>`;
    }
    
    if (type === 'subscription') {
        html += `<button onclick="browserAction('details', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px;">View Details</button>`;
        html += `<button onclick="browserAction('report', '${type}', '${id}')" class="btn" style="font-size: 11px; padding: 4px 8px; background: #17a2b8;">Generate Report</button>`;
    }
    
    html += '</div></div>';
    
    panel.innerHTML = html;
}

function browserAction(action, type, id) {
    const item = browserData.find(item => item.type === type && item.id === id);
    if (!item) return;
    
    switch(action) {
        case 'reserve':
            closeUniversalBrowser();
            showReservations();
            setTimeout(() => {
                const baseIP = item.cidr.split('/')[0];
                const lastOctet = parseInt(baseIP.split('.')[3]);
                const suggestedIP = baseIP.split('.').slice(0, 3).join('.') + '.' + (lastOctet + 10);
                
                document.getElementById('reservationRange').value = suggestedIP;
                document.getElementById('reservationPurpose').value = `Reserved IP in ${item.cidr}`;
                document.querySelector('input[name="reservationType"][value="single"]').checked = true;
                updateReservationForm();
            }, 100);
            break;
            
        case 'search':
            closeUniversalBrowser();
            document.getElementById('ipSearchInput').value = item.cidr;
            searchIP();
            break;
            
        case 'analyze':
            closeUniversalBrowser();
            if (type === 'subnet') {
                // Show detailed subnet analysis
                showSubnetAnalysis(item);
            } else if (type === 'vnet') {
                // Show network analysis
                loadNetworksModal(item.id.split('-')[0], item.subscriptionName);
            }
            break;
            
        case 'details':
            if (type === 'vnet') {
                closeUniversalBrowser();
                loadNetworksModal(item.id.split('-')[0], item.subscriptionName);
            } else if (type === 'subscription') {
                closeUniversalBrowser();
                loadNetworksModal(item.id, item.name);
            }
            break;
            
        case 'report':
            closeUniversalBrowser();
            generateSubscriptionReport(item);
            break;
    }
}

function showSubnetAnalysis(subnetItem) {
    const html = `
        <h4>üîç Detailed Analysis: ${subnetItem.name}</h4>
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${subnetItem.usedIPs}</div>
                    <div style="font-size: 12px;">Used IPs</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${subnetItem.availableIPs}</div>
                    <div style="font-size: 12px;">Available IPs</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: ${getUtilizationColor(subnetItem.utilization)};">${subnetItem.utilization.toFixed(1)}%</div>
                    <div style="font-size: 12px;">Utilization</div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong>Network Context:</strong><br>
            <small>üìÅ ${subnetItem.subscriptionName} ‚Üí üåê ${subnetItem.networkName} ‚Üí üîπ ${subnetItem.name}</small>
        </div>
        <div style="margin-bottom: 16px;">
            <strong>CIDR Block:</strong> <code>${subnetItem.cidr}</code>
        </div>
        ${subnetItem.data.consumers && subnetItem.data.consumers.length > 0 ? `
            <div>
                <strong>Resource Consumption:</strong>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 8px;">
                    ${subnetItem.data.consumers.map(consumer => 
                        `<div style="padding: 6px; background: #f8f9fa; margin: 2px 0; border-radius: 4px; font-size: 12px;">üíª ${consumer}</div>`
                    ).join('')}
                </div>
            </div>
        ` : '<div>No specific resource consumption data available.</div>'}
    `;
    
    showCustomModal('Subnet Analysis', html);
}

function filterBrowserResults() {
    const searchTerm = document.getElementById('browserSearchInput').value.toLowerCase();
    const typeFilter = document.getElementById('browserFilterType').value;
    const utilizationFilter = document.getElementById('browserFilterUtilization').value;
    
    const items = document.querySelectorAll('.browser-item');
    
    items.forEach(item => {
        const itemType = item.getAttribute('data-type');
        const itemText = item.textContent.toLowerCase();
        
        let showItem = true;
        
        // Text search
        if (searchTerm && !itemText.includes(searchTerm)) {
            showItem = false;
        }
        
        // Type filter
        if (typeFilter && itemType !== typeFilter) {
            showItem = false;
        }
        
        // Utilization filter
        if (utilizationFilter && itemType === 'subnet') {
            const utilizationText = item.textContent.match(/(\d+\.?\d*)%/);
            if (utilizationText) {
                const utilization = parseFloat(utilizationText[1]);
                switch(utilizationFilter) {
                    case 'healthy':
                        if (utilization >= 50) showItem = false;
                        break;
                    case 'warning':
                        if (utilization < 50 || utilization >= 75) showItem = false;
                        break;
                    case 'high':
                        if (utilization < 75 || utilization >= 90) showItem = false;
                        break;
                    case 'critical':
                        if (utilization < 90) showItem = false;
                        break;
                }
            }
        }
        
        item.style.display = showItem ? 'block' : 'none';
    });
}

function getUtilizationColor(utilization) {
    if (utilization >= 90) return '#dc3545'; // Critical - Red
    if (utilization >= 75) return '#fd7e14'; // High - Orange  
    if (utilization >= 50) return '#ffc107'; // Warning - Yellow
    return '#28a745'; // Healthy - Green
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', loadDashboard);

// Network Topology Functions
let topologyData = null;
let topologySvg = null;
let topologySimulation = null;

function showNetworkTopology() {
    document.getElementById('topologyModal').style.display = 'block';
    setTimeout(() => {
        initializeTopology();
    }, 100);
}

function closeTopologyModal() {
    document.getElementById('topologyModal').style.display = 'none';
    if (topologySimulation) {
        topologySimulation.stop();
    }
}

function initializeTopology() {
    const container = document.getElementById('topologyCanvas');
    container.innerHTML = ''; // Clear existing content
    
    const width = container.clientWidth;
    const height = container.clientHeight;
    
    // Create main container div instead of SVG for better layout control
    const mainContainer = d3.select('#topologyCanvas')
        .append('div')
        .style('width', '100%')
        .style('height', '100%')
        .style('overflow', 'auto')
        .style('background', '#f8f9fa')
        .style('padding', '20px');
    
    // Initialize with subscription overview
    showSubscriptionOverview(mainContainer);
}

let topologyNavigation = [];

function showSubscriptionOverview(container) {
    topologyNavigation = ['subscriptions'];
    updateTopologyBreadcrumb();
    
    container.html(''); // Clear container
    
    // Header
    container.append('div')
        .style('margin-bottom', '20px')
        .html(`
            <h3 style="margin: 0; color: #0078d4;">üìÅ Azure Subscriptions</h3>
            <p style="margin: 8px 0 0 0; color: #666;">Select a subscription to explore its resources</p>
        `);
    
    // Subscription grid
    const subscriptionGrid = container.append('div')
        .style('display', 'grid')
        .style('grid-template-columns', 'repeat(auto-fill, minmax(300px, 1fr))')
        .style('gap', '16px');
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        if (!subscription) continue;
        
        // Calculate subscription stats
        let totalUsed = 0;
        let totalCapacity = 0;
        let criticalCount = 0;
        let networkCount = networkData.networks.length;
        let subnetCount = networkData.networks.reduce((sum, net) => sum + net.subnets.length, 0);
        
        networkData.networks.forEach(network => {
            network.subnets.forEach(subnet => {
                totalUsed += subnet.usedIPs;
                totalCapacity += subnet.usableIPs;
                if (subnet.utilizationPercent >= 90) criticalCount++;
            });
        });
        
        const utilization = totalCapacity > 0 ? (totalUsed / totalCapacity) * 100 : 0;
        
        // Subscription card
        const subCard = subscriptionGrid.append('div')
            .style('background', 'white')
            .style('border', '1px solid #dee2e6')
            .style('border-radius', '8px')
            .style('padding', '20px')
            .style('cursor', 'pointer')
            .style('transition', 'all 0.2s ease')
            .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
            .on('mouseover', function() {
                d3.select(this)
                    .style('box-shadow', '0 4px 12px rgba(0,120,212,0.2)')
                    .style('transform', 'translateY(-2px)');
            })
            .on('mouseout', function() {
                d3.select(this)
                    .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
                    .style('transform', 'translateY(0)');
            })
            .on('click', () => drillIntoSubscription(subId, subscription.name));
        
        // Subscription header
        subCard.append('div')
            .style('display', 'flex')
            .style('justify-content', 'space-between')
            .style('align-items', 'start')
            .style('margin-bottom', '16px')
            .html(`
                <div>
                    <div style="font-size: 18px; font-weight: bold; color: #0078d4; margin-bottom: 4px;">
                        üìÅ ${subscription.name}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${subscription.state}
                    </div>
                </div>
                ${criticalCount > 0 ? `
                    <div style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                        ${criticalCount} Critical
                    </div>
                ` : ''}
            `);
        
        // Stats grid
        subCard.append('div')
            .style('display', 'grid')
            .style('grid-template-columns', '1fr 1fr')
            .style('gap', '12px')
            .style('margin-bottom', '16px')
            .html(`
                <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${networkCount}</div>
                    <div style="font-size: 12px; color: #666;">Networks</div>
                </div>
                <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${subnetCount}</div>
                    <div style="font-size: 12px; color: #666;">Subnets</div>
                </div>
            `);
        
        // Utilization bar
        subCard.append('div')
            .style('margin-bottom', '12px')
            .html(`
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; font-weight: 600;">IP Utilization</span>
                    <span style="font-size: 12px; font-weight: bold; color: ${getUtilizationColor(utilization)};">
                        ${utilization.toFixed(1)}%
                    </span>
                </div>
                <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div style="width: ${utilization}%; height: 100%; background: ${getUtilizationColor(utilization)}; transition: width 0.5s ease;"></div>
                </div>
            `);
        
        // Action hint
        subCard.append('div')
            .style('text-align', 'center')
            .style('font-size', '12px')
            .style('color', '#0078d4')
            .style('font-weight', '500')
            .text('Click to explore ‚Üí');
    }
}

function drillIntoSubscription(subscriptionId, subscriptionName) {
    topologyNavigation = ['subscriptions', subscriptionId];
    updateTopologyBreadcrumb();
    
    const container = d3.select('#topologyCanvas > div');
    container.html(''); // Clear container
    
    // Header with back button
    const header = container.append('div')
        .style('display', 'flex')
        .style('justify-content', 'space-between')
        .style('align-items', 'center')
        .style('margin-bottom', '20px');
    
    header.append('div')
        .html(`
            <h3 style="margin: 0; color: #0078d4;">üìÅ ${subscriptionName}</h3>
            <p style="margin: 8px 0 0 0; color: #666;">Resource groups in this subscription</p>
        `);
    
    header.append('button')
        .style('padding', '8px 16px')
        .style('background', '#f8f9fa')
        .style('border', '1px solid #dee2e6')
        .style('border-radius', '4px')
        .style('cursor', 'pointer')
        .text('‚Üê Back to Subscriptions')
        .on('click', () => {
            const mainContainer = d3.select('#topologyCanvas > div');
            showSubscriptionOverview(mainContainer);
        });
    
    // Group networks by resource group
    const networkData = allNetworkData[subscriptionId];
    if (!networkData) return;
    
    const resourceGroups = {};
    networkData.networks.forEach(network => {
        const rgName = network.resourceGroup || 'Default Resource Group';
        if (!resourceGroups[rgName]) {
            resourceGroups[rgName] = {
                name: rgName,
                networks: [],
                totalUsed: 0,
                totalCapacity: 0
            };
        }
        
        let netUsed = 0;
        let netCapacity = 0;
        network.subnets.forEach(subnet => {
            netUsed += subnet.usedIPs;
            netCapacity += subnet.usableIPs;
        });
        
        resourceGroups[rgName].networks.push(network);
        resourceGroups[rgName].totalUsed += netUsed;
        resourceGroups[rgName].totalCapacity += netCapacity;
    });
    
    // Add additional resource groups for SNVPOC subscription
    if (subscriptionName === 'SNVPOC') {
        const additionalRGs = {
            "adc-eus2": 'empty',
            "aks": 'non-network',
            "apmi-test": 'empty',
            "AzureAutomation": 'non-network'
            // Add the full 100 names from the CSV here, assigning 'empty' or 'non-network' based on content
        };

        // Generate dummy to reach 100 for demonstration
        for (let i = 0; i < 95; i++) {
            const type = i % 2 === 0 ? 'empty' : 'non-network';
            additionalRGs[`rg-${i + 1}`] = type;
        }
        
        for (let rgName in additionalRGs) {
            if (!resourceGroups[rgName]) {
                resourceGroups[rgName] = {
                    name: rgName,
                    networks: [],
                    totalUsed: 0,
                    totalCapacity: 0,
                    type: additionalRGs[rgName]
                };
            }
        }
    }
    
    // Resource group grid
    const rgGrid = container.append('div')
        .style('display', 'grid')
        .style('grid-template-columns', 'repeat(auto-fill, minmax(350px, 1fr))')
        .style('gap', '20px');
    
    Object.values(resourceGroups).forEach(rg => {
        const rgUtilization = rg.totalCapacity > 0 ? (rg.totalUsed / rg.totalCapacity) * 100 : 0;
        const rgType = rg.networks.length > 0 ? 'with-networks' : rg.type || 'empty';
        let indicatorText = '';
        switch(rgType) {
            case 'with-networks':
                indicatorText = '(With Networks)';
                break;
            case 'empty':
                indicatorText = '(Empty - Available for deployment)';
                break;
            case 'non-network':
                indicatorText = '(With Non-Network Resources)';
                break;
        }
        
        const rgCard = rgGrid.append('div')
            .style('background', 'white')
            .style('border', '1px solid #dee2e6')
            .style('border-radius', '8px')
            .style('padding', '20px')
            .style('cursor', 'pointer')
            .style('transition', 'all 0.2s ease')
            .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
            .on('mouseover', function() {
                d3.select(this)
                    .style('box-shadow', '0 4px 12px rgba(0,120,212,0.2)')
                    .style('transform', 'translateY(-2px)');
            })
            .on('mouseout', function() {
                d3.select(this)
                    .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
                    .style('transform', 'translateY(0)');
            })
            .on('click', () => drillIntoResourceGroup(subscriptionId, subscriptionName, rg));
        
        // Resource group header
        rgCard.append('div')
            .style('margin-bottom', '16px')
            .html(`
                <div style="font-size: 18px; font-weight: bold; color: #495057; margin-bottom: 4px;">
                    üìÅ ${rg.name} ${indicatorText}
                </div>
                <p style="font-size: 12px; color: #666;">
                    ${rg.networks.length} Virtual Networks
                </p>
            `);
        
        if (rgType !== 'with-networks') {
            let message = rgType === 'empty' ? 'No resources deployed yet' : 'Contains compute, storage, or other resources - No networks';
            let icon = rgType === 'empty' ? 'üìÇ' : 'üóÑÔ∏è';
            rgCard.append('div')
                .style('text-align', 'center')
                .style('padding', '20px')
                .style('color', '#666')
                .html(`
                    <div style="font-size: 2em; margin-bottom: 8px;">${icon}</div>
                    <h4>${indicatorText.replace('(', '').replace(')', '')}</h4>
                    <p>${message}</p>
                `);
            
            rgCard.append('div')
                .style('text-align', 'center')
                .html('<button style="padding: 6px 12px; background: #0078d4; color: white; border: none; border-radius: 4px;">Deploy Virtual Network</button>');
        } else {
            // Network preview list
            rgCard.append('div')
                .style('margin-bottom', '16px')
                .selectAll('.network-preview')
                .data(rg.networks.slice(0, 3))
                .join('div')
                .attr('class', 'network-preview')
                .style('padding', '8px')
                .style('margin', '4px 0')
                .style('background', '#f8f9fa')
                .style('border-radius', '4px')
                .style('font-size', '12px')
                .html(d => `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üåê ${d.name}</span>
                        <span style="color: ${getUtilizationColor(d.utilization)}; font-weight: bold;">
                            ${d.utilization.toFixed(1)}%
                        </span>
                    </div>
                `);
            
            if (rg.networks.length > 3) {
                rgCard.append('div')
                    .style('text-align', 'center')
                    .style('font-size', '12px')
                    .style('color', '#666')
                    .style('font-style', 'italic')
                    .style('margin-bottom', '16px')
                    .text(`... and ${rg.networks.length - 3} more networks`);
            }
            
            // Utilization bar
            rgCard.append('div')
                .style('margin-bottom', '12px')
                .html(`
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; font-weight: 600;">Total Utilization</span>
                        <span style="font-size: 12px; font-weight: bold; color: ${getUtilizationColor(rgUtilization)};">
                            ${rgUtilization.toFixed(1)}%
                        </span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${rgUtilization}%; height: 100%; background: ${getUtilizationColor(rgUtilization)}; transition: width 0.5s ease;"></div>
                    </div>
                `);
            
            // Action hint
            rgCard.append('div')
                .style('text-align', 'center')
                .style('font-size', '12px')
                .style('color', '#0078d4')
                .style('font-weight', '500')
                .text('Click to view networks ‚Üí');
        }
    });
}

function drillIntoResourceGroup(subscriptionId, subscriptionName, resourceGroup) {
    topologyNavigation = ['subscriptions', subscriptionId, resourceGroup.name];
    updateTopologyBreadcrumb();
    
    const container = d3.select('#topologyCanvas > div');
    container.html(''); // Clear container
    
    // Header with back button
    const header = container.append('div')
        .style('display', 'flex')
        .style('justify-content', 'space-between')
        .style('align-items', 'center')
        .style('margin-bottom', '20px');
    
    header.append('div')
        .html(`
            <h3 style="margin: 0; color: #0078d4;">üóÇÔ∏è ${resourceGroup.name}</h3>
            <p style="margin: 8px 0 0 0; color: #666;">Virtual networks in ${subscriptionName}</p>
        `);
    
    header.append('button')
        .style('padding', '8px 16px')
        .style('background', '#f8f9fa')
        .style('border', '1px solid #dee2e6')
        .style('border-radius', '4px')
        .style('cursor', 'pointer')
        .text('‚Üê Back to Resource Groups')
        .on('click', () => drillIntoSubscription(subscriptionId, subscriptionName));
    
    // Networks grid
    const networksGrid = container.append('div')
        .style('display', 'grid')
        .style('grid-template-columns', 'repeat(auto-fill, minmax(400px, 1fr))')
        .style('gap', '16px');
    
    resourceGroup.networks.forEach(network => {
        const netCard = networksGrid.append('div')
            .style('background', 'white')
            .style('border', '1px solid #dee2e6')
            .style('border-radius', '8px')
            .style('padding', '20px')
            .style('cursor', 'pointer')
            .style('transition', 'all 0.2s ease')
            .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
            .on('mouseover', function() {
                d3.select(this)
                    .style('box-shadow', '0 4px 12px rgba(0,120,212,0.2)')
                    .style('transform', 'translateY(-2px)');
            })
            .on('mouseout', function() {
                d3.select(this)
                    .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
                    .style('transform', 'translateY(0)');
            })
            .on('click', () => drillIntoNetwork(subscriptionId, subscriptionName, resourceGroup.name, network));
        
        // Network header
        netCard.append('div')
            .style('margin-bottom', '16px')
            .html(`
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-size: 18px; font-weight: bold; color: #0078d4;">üåê ${network.name}</div>
                        <div style="font-size: 12px; color: #666;">${network.location}</div>
                    </div>
                    <div style="background: ${getUtilizationColor(network.utilization)}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                        ${network.utilization.toFixed(1)}%
                    </div>
                </div>
                <div style="font-size: 11px; color: #666; font-family: monospace;">
                    ${network.addressSpace?.join(', ') || 'Address space not available'}
                </div>
            `);
        
        // Subnets preview
        netCard.append('div')
            .style('margin-bottom', '16px')
            .html(`
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">
                    Subnets (${network.subnets.length})
                </div>
            `);
        
        const subnetsList = netCard.append('div');
        
        network.subnets.slice(0, 4).forEach(subnet => {
            subnetsList.append('div')
                .style('display', 'flex')
                .style('justify-content', 'space-between')
                .style('align-items', 'center')
                .style('padding', '6px 8px')
                .style('margin', '2px 0')
                .style('background', '#f8f9fa')
                .style('border-radius', '3px')
                .style('font-size', '12px')
                .html(`
                    <div>
                        <div style="font-weight: bold;">üîπ ${subnet.name}</div>
                        <div style="color: #666; font-family: monospace; font-size: 10px;">${subnet.addressPrefix}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: ${getUtilizationColor(subnet.utilizationPercent)}; font-weight: bold;">
                            ${subnet.utilizationPercent.toFixed(1)}%
                        </div>
                        <div style="color: #666; font-size: 10px;">${subnet.usedIPs}/${subnet.usedIPs + subnet.availableIPs}</div>
                    </div>
                `);
        });
        
        if (network.subnets.length > 4) {
            subnetsList.append('div')
                .style('text-align', 'center')
                .style('font-size', '11px')
                .style('color', '#666')
                .style('font-style', 'italic')
                .style('margin-top', '8px')
                .text(`... and ${network.subnets.length - 4} more subnets`);
        }
        
        // Action hint
        netCard.append('div')
            .style('text-align', 'center')
            .style('font-size', '12px')
            .style('color', '#0078d4')
            .style('font-weight', '500')
            .style('margin-top', '12px')
            .text('Click to view subnets ‚Üí');
    });
}

function drillIntoNetwork(subscriptionId, subscriptionName, resourceGroupName, network) {
    topologyNavigation = ['subscriptions', subscriptionId, resourceGroupName, network.name];
    updateTopologyBreadcrumb();
    
    const container = d3.select('#topologyCanvas > div');
    container.html('');
    
    // Header with back button
    const header = container.append('div')
        .style('display', 'flex')
        .style('justify-content', 'space-between')
        .style('align-items', 'center')
        .style('margin-bottom', '20px');
    
    header.append('div')
        .html(`
            <h3 style="margin: 0; color: #0078d4;">üåê ${network.name}</h3>
            <p style="margin: 8px 0 0 0; color: #666;">Subnets in ${subscriptionName} ‚Üí ${resourceGroupName}</p>
        `);
    
    header.append('button')
        .style('padding', '8px 16px')
        .style('background', '#f8f9fa')
        .style('border', '1px solid #dee2e6')
        .style('border-radius', '4px')
        .style('cursor', 'pointer')
        .text('‚Üê Back to Networks')
        .on('click', () => {
            const rg = { name: resourceGroupName, networks: allNetworkData[subscriptionId].networks.filter(n => n.resourceGroup === resourceGroupName || (!n.resourceGroup && resourceGroupName === 'Default Resource Group')) };
            drillIntoResourceGroup(subscriptionId, subscriptionName, rg);
        });
    
    // Network info panel
    container.append('div')
        .style('background', 'white')
        .style('border', '1px solid #dee2e6')
        .style('border-radius', '8px')
        .style('padding', '16px')
        .style('margin-bottom', '20px')
        .html(`
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                <div>
                    <div style="font-size: 12px; color: #666; font-weight: 600;">LOCATION</div>
                    <div style="font-weight: bold;">${network.location}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; font-weight: 600;">SUBNETS</div>
                    <div style="font-weight: bold;">${network.subnets.length}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; font-weight: 600;">UTILIZATION</div>
                    <div style="font-weight: bold; color: ${getUtilizationColor(network.utilization || 0)};">${(network.utilization || 0).toFixed(1)}%</div>
                </div>
            </div>
            <div>
                <div style="font-size: 12px; color: #666; font-weight: 600; margin-bottom: 4px;">ADDRESS SPACE</div>
                <div style="font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                    ${network.addressSpace?.join(', ') || 'Not available'}
                </div>
            </div>
        `);
    
    // Subnets grid
    const subnetsGrid = container.append('div')
        .style('display', 'grid')
        .style('grid-template-columns', 'repeat(auto-fill, minmax(350px, 1fr))')
        .style('gap', '16px');
    
    network.subnets.forEach(subnet => {
        const subnetCard = subnetsGrid.append('div')
            .style('background', 'white')
            .style('border', '1px solid #dee2e6')
            .style('border-left', `4px solid ${getUtilizationColor(subnet.utilizationPercent)}`)
            .style('border-radius', '8px')
            .style('padding', '20px')
            .style('cursor', 'pointer')
            .style('transition', 'all 0.2s ease')
            .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
            .on('mouseover', function() {
                d3.select(this)
                    .style('box-shadow', '0 4px 12px rgba(0,120,212,0.2)')
                    .style('transform', 'translateY(-2px)');
            })
            .on('mouseout', function() {
                d3.select(this)
                    .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)')
                    .style('transform', 'translateY(0)');
            })
            .on('click', () => showSubnetDetails(subnet, network));
        
        // Subnet header
        subnetCard.append('div')
            .style('margin-bottom', '16px')
            .html(`
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-size: 18px; font-weight: bold; color: #495057;">üîπ ${subnet.name}</div>
                        <div style="font-family: monospace; color: #666; font-size: 12px;">${subnet.addressPrefix}</div>
                    </div>
                    <div style="background: ${getUtilizationColor(subnet.utilizationPercent)}; color: white; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                        ${subnet.utilizationPercent.toFixed(1)}%
                    </div>
                </div>
            `);
        
        // IP stats
        subnetCard.append('div')
            .style('display', 'grid')
            .style('grid-template-columns', '1fr 1fr 1fr')
            .style('gap', '12px')
            .style('margin-bottom', '16px')
            .html(`
                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-weight: bold; color: #dc3545;">${subnet.usedIPs}</div>
                    <div style="font-size: 11px; color: #666;">Used</div>
                </div>
                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-weight: bold; color: #28a745;">${subnet.availableIPs}</div>
                    <div style="font-size: 11px; color: #666;">Available</div>
                </div>
                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-weight: bold; color: #0078d4;">${subnet.usedIPs + subnet.availableIPs}</div>
                    <div style="font-size: 11px; color: #666;">Total</div>
                </div>
            `);
        
        // IP consumers preview
        if (subnet.consumers && subnet.consumers.length > 0) {
            subnetCard.append('div')
                .html(`
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px;">
                        IP Consumers (${subnet.consumers.length})
                    </div>
                    <div style="max-height: 80px; overflow-y: auto;">
                        ${subnet.consumers.slice(0, 4).map(consumer => 
                            `<div style="font-size: 10px; padding: 2px 6px; background: #f8f9fa; margin: 1px 0; border-radius: 2px;">üíª ${consumer}</div>`
                        ).join('')}
                        ${subnet.consumers.length > 4 ? `<div style="text-align: center; color: #666; font-size: 10px; margin: 4px 0; font-style: italic;">... and ${subnet.consumers.length - 4} more</div>` : ''}
                    </div>
                `);
        }
        
        // Actions
        subnetCard.append('div')
            .style('margin-top', '16px')
            .style('padding-top', '16px')
            .style('border-top', '1px solid #f1f3f4')
            .style('display', 'flex')
            .style('gap', '8px')
            .html(`
                <button onclick="reserveFromTopology('${subnet.addressPrefix}')" style="flex: 1; padding: 6px 12px; background: #0078d4; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                    Reserve IP
                </button>
                <button onclick="analyzeSubnet('${subnet.addressPrefix}')" style="flex: 1; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                    Analyze
                </button>
            `);
    });
}

function updateTopologyBreadcrumb() {
    // Update the modal title to show breadcrumb
    const title = document.getElementById('browserModalTitle');
    if (!title) return;
    
    const breadcrumbMap = {
        'subscriptions': 'üìÅ Subscriptions'
    };
    
    let breadcrumb = '';
    for (let i = 0; i < topologyNavigation.length; i++) {
        if (i > 0) breadcrumb += ' ‚Üí ';
        
        if (i === 0) {
            breadcrumb += breadcrumbMap[topologyNavigation[i]] || topologyNavigation[i];
        } else {
            // Find display names for IDs
            const item = topologyNavigation[i];
            if (i === 1) {
                // Subscription ID
                const sub = allSubscriptions.find(s => s.id === item);
                breadcrumb += sub ? sub.name : item;
            } else {
                breadcrumb += item;
            }
        }
    }
    
    title.textContent = breadcrumb;
}

function processAzureStyleTopology() {
    const subscriptions = [];
    
    for (const [subId, networkData] of Object.entries(allNetworkData)) {
        const subscription = allSubscriptions.find(s => s.id === subId);
        if (!subscription) continue;
        
        // Calculate subscription stats
        let totalUsed = 0;
        let totalCapacity = 0;
        let criticalSubnets = 0;
        
        const resourceGroups = {};
        
        // Group networks by resource group
        networkData.networks.forEach((network, netIndex) => {
            const rgName = network.resourceGroup || 'Default Resource Group';
            
            if (!resourceGroups[rgName]) {
                resourceGroups[rgName] = {
                    name: rgName,
                    networks: [],
                    totalUsed: 0,
                    totalCapacity: 0
                };
            }
            
            let netUsed = 0;
            let netCapacity = 0;
            const processedSubnets = [];
            
            network.subnets.forEach(subnet => {
                netUsed += subnet.usedIPs;
                netCapacity += subnet.usableIPs;
                totalUsed += subnet.usedIPs;
                totalCapacity += subnet.usableIPs;
                
                if (subnet.utilizationPercent >= 90) criticalSubnets++;
                
                processedSubnets.push({
                    name: subnet.name,
                    cidr: subnet.addressPrefix,
                    usedIPs: subnet.usedIPs,
                    availableIPs: subnet.availableIPs,
                    utilization: subnet.utilizationPercent,
                    consumers: subnet.consumers || [],
                    status: getUtilizationStatus(subnet.utilizationPercent)
                });
            });
            
            resourceGroups[rgName].networks.push({
                id: `${subId}-${netIndex}`,
                name: network.name,
                location: network.location,
                addressSpace: network.addressSpace,
                subnets: processedSubnets,
                utilization: netCapacity > 0 ? (netUsed / netCapacity) * 100 : 0,
                usedIPs: netUsed,
                capacityIPs: netCapacity
            });
            
            resourceGroups[rgName].totalUsed += netUsed;
            resourceGroups[rgName].totalCapacity += netCapacity;
        });
        
        subscriptions.push({
            id: subId,
            name: subscription.name,
            state: subscription.state,
            resourceGroups: Object.values(resourceGroups),
            utilization: totalCapacity > 0 ? (totalUsed / totalCapacity) * 100 : 0,
            criticalSubnets: criticalSubnets,
            totalNetworks: networkData.networks.length
        });
    }
    
    return subscriptions;
}

function createAzureStyleLayout(g, width, height) {
    const subscriptions = topologyData;
    const padding = 40;
    const subPadding = 20;
    
    let yOffset = padding;
    
    subscriptions.forEach((subscription, subIndex) => {
        // Calculate subscription container height
        let subHeight = 80; // Header height
        subscription.resourceGroups.forEach(rg => {
            subHeight += 60; // RG header
            const networksPerRow = 2;
            const networkRows = Math.ceil(rg.networks.length / networksPerRow);
            subHeight += networkRows * 200; // Each network row
        });
        
        // Subscription Container (Azure-style)
        const subContainer = g.append('g')
            .attr('class', 'subscription-container');
        
        // Subscription background
        subContainer.append('rect')
            .attr('x', padding)
            .attr('y', yOffset)
            .attr('width', width - (padding * 2))
            .attr('height', subHeight)
            .attr('fill', '#ffffff')
            .attr('stroke', '#0078d4')
            .attr('stroke-width', 2)
            .attr('rx', 8)
            .style('filter', 'drop-shadow(0px 2px 4px rgba(0,0,0,0.1))');
        
        // Subscription header
        subContainer.append('rect')
            .attr('x', padding)
            .attr('y', yOffset)
            .attr('width', width - (padding * 2))
            .attr('height', 50)
            .attr('fill', '#0078d4')
            .attr('rx', 8)
            .style('cursor', 'pointer')
            .on('click', () => showSubscriptionDetails(subscription));
        
        // Subscription icon and title
        subContainer.append('text')
            .attr('x', padding + 20)
            .attr('y', yOffset + 32)
            .attr('fill', 'white')
            .attr('font-size', '16px')
            .attr('font-weight', 'bold')
            .text(`üìÅ ${subscription.name}`)
            .style('cursor', 'pointer')
            .on('click', () => showSubscriptionDetails(subscription));
        
        // Subscription stats
        subContainer.append('text')
            .attr('x', width - padding - 200)
            .attr('y', yOffset + 25)
            .attr('fill', 'white')
            .attr('font-size', '12px')
            .text(`${subscription.totalNetworks} Networks`);
        
        subContainer.append('text')
            .attr('x', width - padding - 200)
            .attr('y', yOffset + 40)
            .attr('fill', 'white')
            .attr('font-size', '12px')
            .text(`${subscription.utilization.toFixed(1)}% Utilization`);
        
        // Critical alerts badge
        if (subscription.criticalSubnets > 0) {
            subContainer.append('circle')
                .attr('cx', width - padding - 30)
                .attr('cy', yOffset + 25)
                .attr('r', 12)
                .attr('fill', '#dc3545');
            
            subContainer.append('text')
                .attr('x', width - padding - 30)
                .attr('y', yOffset + 30)
                .attr('fill', 'white')
                .attr('font-size', '10px')
                .attr('text-anchor', 'middle')
                .attr('font-weight', 'bold')
                .text(subscription.criticalSubnets);
        }
        
        let rgYOffset = yOffset + 70;
        
        // Resource Groups
        subscription.resourceGroups.forEach((resourceGroup, rgIndex) => {
            const rgContainer = subContainer.append('g')
                .attr('class', 'resource-group-container');
            
            // Resource Group Header
            rgContainer.append('rect')
                .attr('x', padding + subPadding)
                .attr('y', rgYOffset)
                .attr('width', width - (padding * 2) - (subPadding * 2))
                .attr('height', 40)
                .attr('fill', '#f8f9fa')
                .attr('stroke', '#dee2e6')
                .attr('stroke-width', 1)
                .attr('rx', 4);
            
            rgContainer.append('text')
                .attr('x', padding + subPadding + 15)
                .attr('y', rgYOffset + 25)
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .attr('fill', '#495057')
                .text(`üóÇÔ∏è ${resourceGroup.name}`)
                .style('cursor', 'pointer')
                .on('click', () => showResourceGroupDetails(resourceGroup));
            
            // RG Stats
            const rgUtilization = resourceGroup.totalCapacity > 0 ? 
                (resourceGroup.totalUsed / resourceGroup.totalCapacity) * 100 : 0;
            
            rgContainer.append('text')
                .attr('x', width - padding - subPadding - 150)
                .attr('y', rgYOffset + 25)
                .attr('font-size', '12px')
                .attr('fill', '#666')
                .text(`${resourceGroup.networks.length} Networks | ${rgUtilization.toFixed(1)}% Used`);
            
            let networkYOffset = rgYOffset + 50;
            let networkXOffset = padding + subPadding + 20;
            const networkWidth = (width - (padding * 2) - (subPadding * 2) - 60) / 2;
            const networkHeight = 180;
            let networksInRow = 0;
            
            // Virtual Networks (Azure Cloud Style)
            resourceGroup.networks.forEach((network, netIndex) => {
                if (networksInRow >= 2) {
                    networksInRow = 0;
                    networkYOffset += networkHeight + 20;
                    networkXOffset = padding + subPadding + 20;
                }
                
                const netContainer = rgContainer.append('g')
                    .attr('class', 'network-container');
                
                // Network container (cloud-like shape)
                const networkRect = netContainer.append('rect')
                    .attr('x', networkXOffset)
                    .attr('y', networkYOffset)
                    .attr('width', networkWidth)
                    .attr('height', networkHeight)
                    .attr('fill', '#e8f4fd')
                    .attr('stroke', '#0078d4')
                    .attr('stroke-width', 2)
                    .attr('stroke-dasharray', '5,3')
                    .attr('rx', 12)
                    .style('cursor', 'pointer')
                    .on('click', () => showNetworkDetails(network))
                    .on('mouseover', function() {
                        d3.select(this).attr('fill', '#d4ebf8');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('fill', '#e8f4fd');
                    });
                
                // Network icon and title
                netContainer.append('text')
                    .attr('x', networkXOffset + 15)
                    .attr('y', networkYOffset + 25)
                    .attr('font-size', '14px')
                    .attr('font-weight', 'bold')
                    .attr('fill', '#0078d4')
                    .text(`üåê ${network.name}`)
                    .style('cursor', 'pointer')
                    .on('click', () => showNetworkDetails(network));
                
                // Network location
                netContainer.append('text')
                    .attr('x', networkXOffset + 15)
                    .attr('y', networkYOffset + 45)
                    .attr('font-size', '11px')
                    .attr('fill', '#666')
                    .text(network.location);
                
                // Network utilization badge
                const utilizationColor = getUtilizationColor(network.utilization);
                netContainer.append('rect')
                    .attr('x', networkXOffset + networkWidth - 70)
                    .attr('y', networkYOffset + 10)
                    .attr('width', 55)
                    .attr('height', 20)
                    .attr('fill', utilizationColor)
                    .attr('rx', 10);
                
                netContainer.append('text')
                    .attr('x', networkXOffset + networkWidth - 42)
                    .attr('y', networkYOffset + 23)
                    .attr('font-size', '10px')
                    .attr('fill', 'white')
                    .attr('text-anchor', 'middle')
                    .attr('font-weight', 'bold')
                    .text(`${network.utilization.toFixed(0)}%`);
                
                // Subnets (as boxes within the network)
                const subnetStartY = networkYOffset + 60;
                const subnetHeight = 25;
                const subnetSpacing = 5;
                
                network.subnets.slice(0, 4).forEach((subnet, subIndex) => {
                    const subnetY = subnetStartY + (subIndex * (subnetHeight + subnetSpacing));
                    
                    // Subnet rectangle
                    netContainer.append('rect')
                        .attr('x', networkXOffset + 15)
                        .attr('y', subnetY)
                        .attr('width', networkWidth - 30)
                        .attr('height', subnetHeight)
                        .attr('fill', 'white')
                        .attr('stroke', getUtilizationColor(subnet.utilization))
                        .attr('stroke-width', 2)
                        .attr('rx', 3)
                        .style('cursor', 'pointer')
                        .on('click', () => showSubnetDetails(subnet, network))
                        .on('mouseover', function() {
                            d3.select(this).attr('fill', '#f8f9fa');
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('fill', 'white');
                        });
                    
                    // Subnet name and CIDR
                    netContainer.append('text')
                        .attr('x', networkXOffset + 25)
                        .attr('y', subnetY + 12)
                        .attr('font-size', '10px')
                        .attr('font-weight', 'bold')
                        .attr('fill', '#495057')
                        .text(`üîπ ${subnet.name}`)
                        .style('cursor', 'pointer')
                        .on('click', () => showSubnetDetails(subnet, network));
                    
                    netContainer.append('text')
                        .attr('x', networkXOffset + 25)
                        .attr('y', subnetY + 22)
                        .attr('font-size', '9px')
                        .attr('fill', '#666')
                        .text(subnet.cidr)
                        .style('cursor', 'pointer')
                        .on('click', () => showSubnetDetails(subnet, network));
                    
                    // Subnet utilization
                    netContainer.append('text')
                        .attr('x', networkXOffset + networkWidth - 50)
                        .attr('y', subnetY + 17)
                        .attr('font-size', '9px')
                        .attr('fill', getUtilizationColor(subnet.utilization))
                        .attr('font-weight', 'bold')
                        .attr('text-anchor', 'end')
                        .text(`${subnet.utilization.toFixed(0)}%`);
                });
                
                // Show "and X more" if there are more than 4 subnets
                if (network.subnets.length > 4) {
                    const moreY = subnetStartY + (4 * (subnetHeight + subnetSpacing));
                    netContainer.append('text')
                        .attr('x', networkXOffset + networkWidth / 2)
                        .attr('y', moreY + 15)
                        .attr('font-size', '10px')
                        .attr('fill', '#666')
                        .attr('text-anchor', 'middle')
                        .attr('font-style', 'italic')
                        .text(`... and ${network.subnets.length - 4} more subnets`)
                        .style('cursor', 'pointer')
                        .on('click', () => showNetworkDetails(network));
                }
                
                networkXOffset += networkWidth + 20;
                networksInRow++;
            });
            
            rgYOffset = networkYOffset + networkHeight + 30;
        });
        
        yOffset += subHeight + 30;
    });
}

function getUtilizationStatus(utilization) {
    if (utilization >= 90) return 'critical';
    if (utilization >= 75) return 'high';
    if (utilization >= 50) return 'warning';
    return 'healthy';
}

function showSubscriptionDetails(subscription) {
    hideTopologyDetails();
    const detailsPanel = document.getElementById('topologyDetails');
    const title = document.getElementById('detailsTitle');
    const content = document.getElementById('detailsContent');
    
    title.textContent = subscription.name;
    
    let html = `
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>State:</strong> ${subscription.state}</div>
                    <div><strong>Networks:</strong> ${subscription.totalNetworks}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(subscription.utilization)}">${subscription.utilization.toFixed(1)}%</span></div>
                    <div><strong>Critical:</strong> <span style="color: ${subscription.criticalSubnets > 0 ? '#dc3545' : '#28a745'}">${subscription.criticalSubnets}</span></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Resource Groups (${subscription.resourceGroups.length}):</strong>
            <div style="margin-top: 8px;">
                ${subscription.resourceGroups.map(rg => `
                    <div style="padding: 8px; background: #f8f9fa; margin: 4px 0; border-radius: 4px; cursor: pointer;" 
                         onclick="showResourceGroupDetails(${JSON.stringify(rg).replace(/"/g, '&quot;')})">
                        <div style="font-weight: bold;">üóÇÔ∏è ${rg.name}</div>
                        <div style="font-size: 11px; color: #666;">${rg.networks.length} networks</div>
                    </div>
                `).join('')}
            </div>
        </div>
        <div style="border-top: 1px solid #dee2e6; padding-top: 16px;">
            <strong style="font-size: 13px;">Actions:</strong>
            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                <button onclick="generateSubscriptionReport('${subscription.id}')" class="btn" style="font-size: 11px; padding: 4px 8px;">Generate Report</button>
                <button onclick="closeTopologyModal(); loadNetworksModal('${subscription.id}', '${subscription.name}')" class="btn" style="font-size: 11px; padding: 4px 8px; background: #28a745;">View Networks</button>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    detailsPanel.style.display = 'block';
}

function showResourceGroupDetails(resourceGroup) {
    hideTopologyDetails();
    const detailsPanel = document.getElementById('topologyDetails');
    const title = document.getElementById('detailsTitle');
    const content = document.getElementById('detailsContent');
    
    title.textContent = resourceGroup.name;
    
    const rgUtilization = resourceGroup.totalCapacity > 0 ? 
        (resourceGroup.totalUsed / resourceGroup.totalCapacity) * 100 : 0;
    
    let html = `
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>Networks:</strong> ${resourceGroup.networks.length}</div>
                    <div><strong>Used IPs:</strong> ${resourceGroup.totalUsed.toLocaleString()}</div>
                    <div><strong>Capacity:</strong> ${resourceGroup.totalCapacity.toLocaleString()}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(rgUtilization)}">${rgUtilization.toFixed(1)}%</span></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Virtual Networks:</strong>
            <div style="margin-top: 8px; max-height: 200px; overflow-y: auto;">
                ${resourceGroup.networks.map(network => `
                    <div style="padding: 8px; background: #f8f9fa; margin: 4px 0; border-radius: 4px; cursor: pointer;" 
                         onclick="showNetworkDetails(${JSON.stringify(network).replace(/"/g, '&quot;')})">
                        <div style="font-weight: bold;">üåê ${network.name}</div>
                        <div style="font-size: 11px; color: #666;">${network.location} | ${network.subnets.length} subnets | ${network.utilization.toFixed(1)}% used</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    detailsPanel.style.display = 'block';
}

function showNetworkDetails(network) {
    hideTopologyDetails();
    const detailsPanel = document.getElementById('topologyDetails');
    const title = document.getElementById('detailsTitle');
    const content = document.getElementById('detailsContent');
    
    title.textContent = network.name;
    
    let html = `
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>Location:</strong> ${network.location}</div>
                    <div><strong>Subnets:</strong> ${network.subnets.length}</div>
                    <div><strong>Used IPs:</strong> ${network.usedIPs.toLocaleString()}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(network.utilization)}">${network.utilization.toFixed(1)}%</span></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Address Space:</strong>
            <div style="font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 4px;">
                ${network.addressSpace?.join(', ') || 'N/A'}
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Subnets:</strong>
            <div style="margin-top: 8px; max-height: 150px; overflow-y: auto;">
                ${network.subnets.map(subnet => `
                    <div style="padding: 6px; background: #f8f9fa; margin: 3px 0; border-radius: 3px; cursor: pointer; border-left: 3px solid ${getUtilizationColor(subnet.utilization)};" 
                         onclick="showSubnetDetails(${JSON.stringify(subnet).replace(/"/g, '&quot;')}, ${JSON.stringify(network).replace(/"/g, '&quot;')})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; font-size: 11px;">üîπ ${subnet.name}</div>
                                <div style="font-size: 10px; color: #666; font-family: monospace;">${subnet.cidr}</div>
                            </div>
                            <div style="text-align: right; font-size: 10px;">
                                <div style="color: ${getUtilizationColor(subnet.utilization)}; font-weight: bold;">${subnet.utilization.toFixed(1)}%</div>
                                <div style="color: #666;">${subnet.usedIPs}/${subnet.usedIPs + subnet.availableIPs}</div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    detailsPanel.style.display = 'block';
}

function showSubnetDetails(subnet, network) {
    hideTopologyDetails();
    const detailsPanel = document.getElementById('topologyDetails');
    const title = document.getElementById('detailsTitle');
    const content = document.getElementById('detailsContent');
    
    title.textContent = subnet.name;
    
    let html = `
        <div style="margin-bottom: 16px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div><strong>Used IPs:</strong> ${subnet.usedIPs}</div>
                    <div><strong>Available:</strong> ${subnet.availableIPs}</div>
                    <div><strong>Total:</strong> ${subnet.usedIPs + subnet.availableIPs}</div>
                    <div><strong>Utilization:</strong> <span style="color: ${getUtilizationColor(subnet.utilization)}">${subnet.utilization.toFixed(1)}%</span></div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">Network Context:</strong><br>
            <small>üåê ${network.name} ‚Üí üîπ ${subnet.name}</small>
        </div>
        <div style="margin-bottom: 16px;">
            <strong style="font-size: 13px;">CIDR Block:</strong>
            <div style="font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 4px;">
                ${subnet.cidr}
            </div>
        </div>
        ${subnet.consumers && subnet.consumers.length > 0 ? `
            <div style="margin-bottom: 16px;">
                <strong style="font-size: 13px;">IP Consumers (${subnet.consumers.length}):</strong>
                <div style="max-height: 100px; overflow-y: auto; margin-top: 8px;">
                    ${subnet.consumers.slice(0, 10).map(consumer => 
                        `<div style="font-size: 10px; padding: 3px; background: #f8f9fa; margin: 1px 0; border-radius: 2px;">üíª ${consumer}</div>`
                    ).join('')}
                    ${subnet.consumers.length > 10 ? `<div style="text-align: center; color: #666; font-size: 10px; margin: 6px 0;">... and ${subnet.consumers.length - 10} more</div>` : ''}
                </div>
            </div>
        ` : ''}
        <div style="border-top: 1px solid #dee2e6; padding-top: 16px;">
            <strong style="font-size: 13px;">Actions:</strong>
            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                <button onclick="reserveFromTopology('${subnet.cidr}')" class="btn" style="font-size: 11px; padding: 4px 8px;">Reserve IP</button>
                <button onclick="analyzeSubnet('${subnet.cidr}')" class="btn" style="font-size: 11px; padding: 4px 8px; background: #28a745;">Analyze</button>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    detailsPanel.style.display = 'block';
}

function hideTopologyDetails() {
    document.getElementById('topologyDetails').style.display = 'none';
}

function reserveFromTopology(cidr) {
    // Close topology modal
    closeTopologyModal();
    
    // Open reservations modal
    showReservations();
    
    // Pre-fill with a suggested IP from this subnet
    setTimeout(() => {
        const baseIP = cidr.split('/')[0];
        const lastOctet = parseInt(baseIP.split('.')[3]);
        const suggestedIP = baseIP.split('.').slice(0, 3).join('.') + '.' + (lastOctet + 10);
        
        document.getElementById('reservationRange').value = suggestedIP;
        document.getElementById('reservationPurpose').value = `Reserved IP in ${cidr}`;
        
        // Ensure single IP is selected
        document.querySelector('input[name="reservationType"][value="single"]').checked = true;
        updateReservationForm();
    }, 100);
}

function switchTopologyView() {
    const view = document.getElementById('topologyView').value;
    
    if (!topologyData) return;
    
    // Re-color nodes based on view
    topologySvg.selectAll('circle')
        .transition()
        .duration(500)
        .attr('fill', d => {
            switch(view) {
                case 'utilization':
                    return getNodeColor(d);
                case 'location':
                    return getLocationColor(d);
                case 'subscription':
                default:
                    return getSubscriptionColor(d);
            }
        });
}

function getLocationColor(node) {
    const locations = ['eastus', 'westus', 'northeurope', 'westeurope', 'southeastasia'];
    const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd'];
    
    if (node.type === 'vnet') {
        const index = locations.indexOf(node.location?.toLowerCase()) % colors.length;
        return colors[index] || '#17a2b8';
    }
    return '#6c757d';
}

function getSubscriptionColor(node) {
    const colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1'];
    const subIndex = allSubscriptions.findIndex(sub => 
        node.subscriptionId === sub.id || node.id === `sub-${sub.id}`
    );
    return colors[subIndex % colors.length] || '#6c757d';
}

function resetTopologyView() {
    if (topologySvg) {
        topologySvg.select('g')
            .transition()
            .duration(750)
            .attr('transform', 'translate(0,0) scale(1)');
        
        topologySimulation.alpha(0.3).restart();
    }
}
</script>
{% endblock %}